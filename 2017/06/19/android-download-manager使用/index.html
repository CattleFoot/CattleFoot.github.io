<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>android_download_manager使用 | CallteFoot&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta name="keywords" content="Android,Download Manager">
<meta property="og:type" content="article">
<meta property="og:title" content="android_download_manager使用">
<meta property="og:url" content="https://cattlefoot.github.io/2017/06/19/android-download-manager使用/index.html">
<meta property="og:site_name" content="CallteFoot's blog">
<meta property="og:description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta property="og:image" content="https://cattlefoot.github.io/images/DownloadManager.png">
<meta property="og:updated_time" content="2017-06-21T15:49:31.997Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android_download_manager使用">
<meta name="twitter:description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta name="twitter:image" content="https://cattlefoot.github.io/images/DownloadManager.png">
  
    <link rel="alternate" href="/atom.xml" title="CallteFoot&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">CallteFoot&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cattlefoot.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-android-download-manager使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/19/android-download-manager使用/" class="article-date">
  <time datetime="2017-06-19T14:51:02.000Z" itemprop="datePublished">2017-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      android_download_manager使用
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&ensp;&ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理<strong>HTTP/HTTPS</strong>连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。<br>&ensp;&ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别是当用户切换不同的应用以后下载需要在后台继续进行，以及当下载任务顺利完成非常重要的情况（DownloadManager对于断点续传功能支持很好）。<br>&ensp;&ensp;要想使用Download Manager，使用getSystemService方法请求系统的DOWNLOAD_SERVICE服务，代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String serviceString = Context.DOWNLOAD_SERVICE;  </div><div class="line">DownloadManager downloadManager;  </div><div class="line">downloadManager = (DownloadManager) getSystemService(serviceString);</div></pre></td></tr></table></figure></p>
<h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><p>&ensp;&ensp;需要一个请求下载操作，创建一个DownloadManager.Request对象，将要请求下载的文件的Uri传递给Download Manager的enqueue方法，代码片段如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(<span class="string">"http://developer.android.com/shareables/icon_templates-v4.0.zip"</span>);  </div><div class="line">DownloadManager.Request request = <span class="keyword">new</span> Request(uri);  </div><div class="line"><span class="keyword">long</span> reference = downloadManager.enqueue(request);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;在这里返回的reference变量是系统为当前的下载请求分配的一个唯一的ID，我们可以通过这个ID重新获得这个下载任务，进行一些自己想要进行的操作或者查询下载的状态以及取消下载等等。</p>
<p>&ensp;&ensp;我们可以通过addRequestHeader方法为DownloadManager.Request对象request添加HTTP头，也可以通过setMimeType方法重写从服务器返回的mime type。</p>
<p>&ensp;&ensp;我们还可以指定在什么连接状态下执行下载操作。setAllowedNetworkTypes方法可以用来限定在WiFi还是手机网络下进行下载，setAllowedOverRoaming方法可以用来阻止手机在漫游状态下下载。</p>
<p>&ensp;&ensp;下面的代码片段用于指定一个较大的文件只能在WiFi下进行下载：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request.setAllowedNetworkTypes(Request.NETWORK_WIFI);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;Android API level 11 介绍了getRecommendedMaxBytesOverMobile类方法（静态方法），返回一个当前手机网络连接下的最大建议字节数，可以来判断下载是否应该限定在WiFi条件下。</p>
<p>&ensp;&ensp;调用enqueue方法之后，只要数据连接可用并且Download Manager可用，下载就会开始。</p>
<p>&ensp;&ensp;要在下载完成的时候获得一个系统通知（notification）,注册一个广播接受者来接收<strong>ACTION_DOWNLOAD_COMPLETE</strong>广播，这个广播会包含一个<br><strong>EXTRA_DOWNLOAD_ID</strong>信息在intent中包含了已经完成的这个下载的ID,代码片段如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">IntentFilter filter = <span class="keyword">new</span> IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE);       </div><div class="line">BroadcastReceiver receiver = <span class="keyword">new</span> BroadcastReceiver() &#123;  </div><div class="line">  <span class="meta">@Override</span>  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </div><div class="line">    <span class="keyword">long</span> reference = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -<span class="number">1</span>);  </div><div class="line">    <span class="keyword">if</span> (myDownloadReference == reference) &#123;  </div><div class="line">      <span class="comment">//do something </span></div><div class="line">    &#125;  </div><div class="line">  &#125;  </div><div class="line">&#125;;  </div><div class="line">registerReceiver(receiver, filter);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;使用Download Manager的openDownloadedFile方法可以打开一个已经下载完成的文件，返回一个ParcelFileDescriptor对象。我们可以通过Download Manager来查询下载文件的保存地址，如果在下载时制定了路径和文件名，我们也可以直接操作文件。</p>
<p>&ensp;&ensp;我们可以为<strong>ACTION_NOTIFICATION_CLICKED</strong> action注册一个广播接受者，当用户从通知栏点击了一个下载项目或者从Downloads app点击可一个下载的项目的时候，系统就会发出一个点击下载项的广播。<br>代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">IntentFilter filter = <span class="keyword">new</span> IntentFilter(DownloadManager.ACTION_NOTIFICATION_CLICKED);    </div><div class="line">BroadcastReceiver receiver = <span class="keyword">new</span> BroadcastReceiver() &#123;  </div><div class="line">  <span class="meta">@Override</span>  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </div><div class="line">    String extraID = DownloadManager.EXTRA_NOTIFICATION_CLICK_DOWNLOAD_IDS;  </div><div class="line">    <span class="keyword">long</span>[] references = intent.getLongArrayExtra(extraID);  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> reference : references)  </div><div class="line">      <span class="keyword">if</span> (reference == myDownloadReference) &#123;  </div><div class="line">        <span class="comment">// Do something with downloading file.  </span></div><div class="line">      &#125;  </div><div class="line">  &#125;  </div><div class="line">&#125;;  </div><div class="line">registerReceiver(receiver, filter);</div></pre></td></tr></table></figure></p>
<h3 id="定制Download-Manager-Notifications的样式"><a href="#定制Download-Manager-Notifications的样式" class="headerlink" title="定制Download Manager Notifications的样式"></a>定制Download Manager Notifications的样式</h3><p>&ensp;&ensp;默认情况下，通知栏中会显示被Download Manager管理的每一个download每一个Notification会显示当前的下载进度和文件的名字。通过Download Manager可以为每一个download request定制Notification的样式，包括完全隐藏Notification。下面的代码片段显示了通过setTitle和setDescription方法来定制显示在文件下载Notification中显示的文字（下载的通知icon不可更改？）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.setTitle(“Earthquakes”);  </div><div class="line">request.setDescription(“Earthquake XML”);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;request.setNotificationVisibility方法可以用来控制什么时候显示Notification，甚至隐藏该request的Notification。有以下几个参数：</p>
<ol>
<li>Request.VISIBILITY_VISIBLE：在下载进行的过程中，通知栏中会一直显示该下载的Notification，当下载完成时，该Notification会被移除，这是默认的参数值；</li>
<li>Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED：在下载过程中通知栏会一直显示该下载的Notification，在下载完成后该Notification会继续显示，直到用户点击该Notification或者消除该Notification；</li>
<li>Request.VISIBILITY_VISIBLE_NOTIFY_ONLY_COMPLETION：只有在下载完成后该Notification才会被显示；</li>
<li>Request.VISIBILITY_HIDDEN：不显示该下载请求的Notification。如果要使用这个参数，需要在应用的清单文件中加上DOWNLOAD_WITHOUT_NOTIFICATION权限。</li>
</ol>
<h3 id="指定下载保存地址"><a href="#指定下载保存地址" class="headerlink" title="指定下载保存地址"></a>指定下载保存地址</h3><p>&ensp;&ensp;默认情况下，所有通过Download Manager下载的文件都保存在一个共享下载缓存中，使用系统生成的文件名每一个Request对象都可以制定一个下载保存的地址，通常情况下，所有的下载文件都应该保存在外部存储中，所以我们需要在应用清单文件中加上WRITE_EXTERNAL_STORAGE权限：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=”android.permission.WRITE_EXTERNAL_STORAGE”/&gt;</div></pre></td></tr></table></figure></p>
<p> 下面的代码片段是在外部存储中指定一个任意的保存位置的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request.setDestinationUri(Uri.fromFile(f));   <span class="comment">// f是一个File对象</span></div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;如果下载的这个文件是你的应用所专用的，你可能会希望把这个文件放在你的应用在外部存储中的一个专有文件夹中。注意这个文件夹不提供访问控制，所以其他的应用也可以访问这个文件夹。在这种情况下，如果你的应用卸载了，那么在这个文件夹也会被删除。<br>&ensp;&ensp;下面的代码片段是指定存储文件的路径是应用在外部存储中的专用文件夹的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.setDestinationInExternalFilesDir(<span class="keyword">this</span>,  </div><div class="line">  Environment.DIRECTORY_DOWNLOADS, “Bugdroid.png”);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;如果下载的文件希望被其他的应用共享，特别是那些你下载下来希望被Media Scanner扫描到的文件（比如音乐文件），那么你可以指定你的下载路径在外部存储的公共文件夹之下，下面的代码片段是将文件存放到外部存储中的公共音乐文件夹的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.setDestinationInExternalPublicDir(Environment.DIRECTORY_MUSIC,  </div><div class="line">     <span class="string">"Android_Rock.mp3"</span>);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;在默认的情况下，通过Download Manager下载的文件是不能被Media Scanner扫描到的，进而这些下载的文件（音乐、视频等）就不会在Gallery和Music Player这样的应用中看到。为了让下载的音乐文件可以被其他应用扫描到，我们需要调用Request对象的allowScaningByMediaScanner方法。如果我们希望下载的文件可以被系统的Downloads应用扫描到并管理，我们需要调用Request对象的setVisibleInDownloadsUi方法，传递参数true。</p>
<h3 id="取消或删除下载"><a href="#取消或删除下载" class="headerlink" title="取消或删除下载"></a>取消或删除下载</h3><p>&ensp;&ensp;Download Manager的remove方法可以用来取消一个准备进行的下载，中止一个正在进行的下载，或者删除一个已经完成的下载。remove方法接受若干个download 的ID作为参数，你可以设置一个或者几个你想要取消的下载的ID，如下代码段所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">downloadManager.remove(REFERENCE_1, REFERENCE_2, REFERENCE_3);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该方法返回成功取消的下载的个数，如果一个下载被取消了，所有相关联的文件，部分下载的文件和完全下载的文件都会被删除。 </p>
<h3 id="查询Download-Manager"><a href="#查询Download-Manager" class="headerlink" title="查询Download Manager"></a>查询Download Manager</h3><p>&ensp;&ensp;你可以通过查询Download Manager来获得下载任务的状态，进度，以及各种细节，通过query方法返回一个包含了下载任务细节的Cursor。query方法传递一个DownloadManager.Query对象作为参数，通过DownloadManager.Query对象的setFilterById方法可以筛选我们希望查询的下载任务的ID。也可以使用setFilterByStatus方法筛选我们希望查询的某一种状态的下载任务，传递的参数是DownloadManager.STATUS<em><em>常量，可以指定正在<em>*进行、暂停、失败、完成</em></em>四种状态。Download Manager包含了一系列COLUMN</em><em>静态String常量，可以用来查询Cursor中的结果列索引。我们可以查询到下载任务的各种细节，包括<em>*状态，文件大小，已经下载的字节数，标题，描述，URI，本地文件名和URI，媒体类型以及Media Provider download URI</em></em>。</p>
<p>&ensp;&ensp;下面的代码段是通过注册监听下载完成事件的广播接受者来查询下载完成文件的本地文件名和URI的实现方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </div><div class="line">      <span class="keyword">long</span> reference = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -<span class="number">1</span>);  </div><div class="line">      <span class="keyword">if</span> (myDownloadReference == reference) &#123;  </div><div class="line">        Query myDownloadQuery = <span class="keyword">new</span> Query();  </div><div class="line">        myDownloadQuery.setFilterById(reference);  </div><div class="line">        Cursor myDownload = downloadManager.query(myDownloadQuery);  </div><div class="line">        <span class="keyword">if</span> (myDownload.moveToFirst()) &#123;</div><div class="line">        <span class="comment">//文件名称索引  </span></div><div class="line">          <span class="keyword">int</span> fileNameIdx =   </div><div class="line">     myDownload.getColumnIndex(DownloadManager.COLUMN_LOCAL_FILENAME);</div><div class="line">     <span class="comment">//下载文件存放地址uri索引</span></div><div class="line">          <span class="keyword">int</span> fileUriIdx =   </div><div class="line">myDownload.getColumnIndex(DownloadManager.COLUMN_LOCAL_URI);  </div><div class="line"><span class="comment">//下载状态</span></div><div class="line">            <span class="keyword">int</span> status = cursor.getInt(cursor.getColumnIndex(DownloadManager.COLUMN_STATUS));  </div><div class="line">             <span class="keyword">switch</span> (status) &#123;  </div><div class="line">            <span class="keyword">case</span> DownloadManager.STATUS_PAUSED:  </div><div class="line">                statusMsg = <span class="string">"STATUS_PAUSED"</span>;  </div><div class="line">            <span class="keyword">case</span> DownloadManager.STATUS_PENDING:  </div><div class="line">                statusMsg = <span class="string">"STATUS_PENDING"</span>;  </div><div class="line">            <span class="keyword">case</span> DownloadManager.STATUS_RUNNING:  </div><div class="line">                statusMsg = <span class="string">"STATUS_RUNNING"</span>;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> DownloadManager.STATUS_SUCCESSFUL:  </div><div class="line">                statusMsg = <span class="string">"STATUS_SUCCESSFUL"</span>;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> DownloadManager.STATUS_FAILED:  </div><div class="line">                statusMsg = <span class="string">"STATUS_FAILED"</span>;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line"> </div><div class="line">            <span class="keyword">default</span>:  </div><div class="line">                statusMsg = <span class="string">"未知状态"</span>;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            &#125;  </div><div class="line">          String fileName = myDownload.getString(fileNameIdx);  </div><div class="line">          String fileUri = myDownload.getString(fileUriIdx);  </div><div class="line">          <span class="comment">// TODO Do something with the file.  </span></div><div class="line">          Log.d(TAG, fileName + <span class="string">" : "</span> + fileUri);  </div><div class="line">        &#125;  </div><div class="line">        myDownload.close();  </div><div class="line">      &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;对于暂停和失败的下载，我们可以通过查询COLUMN_REASON列查询出原因的整数码。</p>
<ol>
<li>对于STATUS<em>PAUSED状态的下载，可以通过DownloadManager.PAUSED</em>* 静态常量来翻译出原因的整数码，进而判断出下载是由于等待网络连接还是等待WiFi连接还是准备重新下载三种原因而暂停。</li>
<li>对于STATUS<em>FAILED状态的下载，我们可以通过DownloadManager.ERROR</em>*来判断失败的原因，可能是错误码（失败原因）包括没有存储设备，存储空间不足，重复的文件名，或者HTTP errors。<br>&ensp;&ensp;下面的代码是如何查询出当前所有的暂停的下载任务，提取出暂停的原因以及文件名称，下载标题以及当前进度的实现方法：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Obtain the Download Manager Service.  </span></div><div class="line">String serviceString = Context.DOWNLOAD_SERVICE;  </div><div class="line">DownloadManager downloadManager;  </div><div class="line">downloadManager = (DownloadManager)getSystemService(serviceString);  </div><div class="line"><span class="comment">// Create a query for paused downloads.  </span></div><div class="line">Query pausedDownloadQuery = <span class="keyword">new</span> Query();  </div><div class="line">pausedDownloadQuery.setFilterByStatus(DownloadManager.STATUS_PAUSED);  </div><div class="line"><span class="comment">// Query the Download Manager for paused downloads.  </span></div><div class="line">Cursor pausedDownloads = downloadManager.query(pausedDownloadQuery);  </div><div class="line"><span class="comment">// Find the column indexes for the data we require.  </span></div><div class="line"><span class="keyword">int</span> reasonIdx = pausedDownloads.getColumnIndex(DownloadManager.COLUMN_REASON);  </div><div class="line"><span class="keyword">int</span> titleIdx = pausedDownloads.getColumnIndex(DownloadManager.COLUMN_TITLE);  </div><div class="line"><span class="keyword">int</span> fileSizeIdx =   </div><div class="line"> pausedDownloads.getColumnIndex(DownloadManager.COLUMN_TOTAL_SIZE_BYTES);      </div><div class="line"><span class="keyword">int</span> bytesDLIdx =   </div><div class="line">pausedDownloads.getColumnIndex(DownloadManager.COLUMN_BYTES_DOWNLOADED_SO_FAR);  </div><div class="line"><span class="comment">// Iterate over the result Cursor.  </span></div><div class="line"><span class="keyword">while</span> (pausedDownloads.moveToNext()) &#123;  </div><div class="line">  <span class="comment">// Extract the data we require from the Cursor.  </span></div><div class="line">  String title = pausedDownloads.getString(titleIdx);  </div><div class="line">  <span class="keyword">int</span> fileSize = pausedDownloads.getInt(fileSizeIdx);  </div><div class="line">  <span class="keyword">int</span> bytesDL = pausedDownloads.getInt(bytesDLIdx);  </div><div class="line">  <span class="comment">// Translate the pause reason to friendly text.  </span></div><div class="line">  <span class="keyword">int</span> reason = pausedDownloads.getInt(reasonIdx);  </div><div class="line">  String reasonString = <span class="string">"Unknown"</span>;  </div><div class="line">  <span class="keyword">switch</span> (reason) &#123;  </div><div class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_QUEUED_FOR_WIFI :   </div><div class="line">      reasonString = <span class="string">"Waiting for WiFi"</span>; <span class="keyword">break</span>;  </div><div class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_WAITING_FOR_NETWORK :   </div><div class="line">      reasonString = <span class="string">"Waiting for connectivity"</span>; <span class="keyword">break</span>;  </div><div class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_WAITING_TO_RETRY :  </div><div class="line">      reasonString = <span class="string">"Waiting to retry"</span>; <span class="keyword">break</span>;  </div><div class="line">    <span class="keyword">default</span> : <span class="keyword">break</span>;  </div><div class="line">  &#125;  </div><div class="line">  <span class="comment">// Construct a status summary  </span></div><div class="line">  StringBuilder sb = <span class="keyword">new</span> StringBuilder();  </div><div class="line">  sb.append(title).append(<span class="string">"\n"</span>);  </div><div class="line">  sb.append(reasonString).append(<span class="string">"\n"</span>);  </div><div class="line">  sb.append(<span class="string">"Downloaded "</span>).append(bytesDL).append(<span class="string">" / "</span> ).append(fileSize);  </div><div class="line">  <span class="comment">// Display the status   </span></div><div class="line">  Log.d(<span class="string">"DOWNLOAD"</span>, sb.toString());  </div><div class="line">&#125;  </div><div class="line"><span class="comment">// Close the result Cursor.  </span></div><div class="line">pausedDownloads.close();</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="DownloadManager原理"><a href="#DownloadManager原理" class="headerlink" title="DownloadManager原理"></a>DownloadManager原理</h3><p>&ensp;&ensp;通过介绍我们已经可以灵活的使用DownloadManaged为我们服务了，为了更好的使用这个工具，得先了解它的工作原理、工作流程。下面就是整个工作流程的时序图：<br><img src="/images/DownloadManager.png" alt="Download Manager时序图"><br>&ensp;&ensp;从上面的时序图我们可以大致了解整个流程。从添加请求，到最后开启下载线程进行文件的下载。为了更好的理解这个下载工具的思想，下面将从源码上对一些重要的函数进行分析。</p>
<p>&ensp;&ensp;一开始，调用DownloadManager的enqueue()法进行下载请求的添加，然后就会调用DownloadProvider的insert()方法进行数据库的数据的插入，insert()不单单是把数据插入到数据库，还会启动DownloadService这个服务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(<span class="keyword">final</span> Uri uri, <span class="keyword">final</span> ContentValues values)</span> </span>&#123;  </div><div class="line">    checkInsertPermissions(values);  </div><div class="line">    SQLiteDatabase db = mOpenHelper.getWritableDatabase();  </div><div class="line">  </div><div class="line">    <span class="comment">// note we disallow inserting into ALL_DOWNLOADS  </span></div><div class="line">       <span class="keyword">if</span> (pckg != <span class="keyword">null</span> &amp;&amp; (clazz != <span class="keyword">null</span> || isPublicApi)) &#123;  </div><div class="line">        <span class="keyword">int</span> uid = Binder.getCallingUid();  </div><div class="line">        <span class="keyword">try</span> &#123;  </div><div class="line">            <span class="keyword">if</span> (uid == <span class="number">0</span> || mSystemFacade.userOwnsPackage(uid, pckg)) &#123;  </div><div class="line">                filteredValues.put(Downloads.COLUMN_NOTIFICATION_PACKAGE,  </div><div class="line">                        pckg);  </div><div class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;  </div><div class="line">                    filteredValues.put(Downloads.COLUMN_NOTIFICATION_CLASS,  </div><div class="line">                            clazz);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException ex) &#123;  </div><div class="line">    <span class="comment">/* ignored for now */</span>  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    copyString(Downloads.COLUMN_NOTIFICATION_EXTRAS, values, filteredValues);  </div><div class="line">    copyString(Downloads.COLUMN_COOKIE_DATA, values, filteredValues);  </div><div class="line">    copyString(Downloads.COLUMN_USER_AGENT, values, filteredValues);  </div><div class="line">    copyString(Downloads.COLUMN_REFERER, values, filteredValues);  </div><div class="line">    <span class="keyword">if</span> (getContext().checkCallingPermission(  </div><div class="line">            Downloads.PERMISSION_ACCESS_ADVANCED) == PackageManager.PERMISSION_GRANTED) &#123;  </div><div class="line">        copyInteger(Downloads.COLUMN_OTHER_UID, values, filteredValues);  </div><div class="line">    &#125;  </div><div class="line">    filteredValues.put(Constants.UID, Binder.getCallingUid());  </div><div class="line">    <span class="keyword">if</span> (Binder.getCallingUid() == <span class="number">0</span>) &#123;  </div><div class="line">        copyInteger(Constants.UID, values, filteredValues);  </div><div class="line">    &#125;  </div><div class="line">    copyStringWithDefault(Downloads.COLUMN_TITLE, values, filteredValues,  </div><div class="line">            <span class="string">""</span>);  </div><div class="line">    copyStringWithDefault(Downloads.COLUMN_DESCRIPTION, values,  </div><div class="line">            filteredValues, <span class="string">""</span>);  </div><div class="line">    filteredValues.put(Downloads.COLUMN_TOTAL_BYTES, -<span class="number">1</span>);  </div><div class="line">    filteredValues.put(Downloads.COLUMN_CURRENT_BYTES, <span class="number">0</span>);  </div><div class="line">  </div><div class="line">  </div><div class="line">    Context context = getContext();  </div><div class="line">    context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));  </div><div class="line">  </div><div class="line">    <span class="keyword">long</span> rowID = db.insert(DB_TABLE, <span class="keyword">null</span>, filteredValues);  </div><div class="line">    <span class="keyword">if</span> (rowID == -<span class="number">1</span>) &#123;  </div><div class="line">        Log.d(Constants.TAG, <span class="string">"couldn't insert into downloads database"</span>);  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    insertRequestHeaders(db, rowID, values);  </div><div class="line">    context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));  </div><div class="line">    notifyContentChanged(uri, match);  </div><div class="line">    <span class="keyword">return</span> ContentUris.withAppendedId(Downloads.CONTENT_URI, rowID);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到上面的代码很长，但是我们只需要关注一些核心的代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> rowID = db.insert(DB_TABLE, <span class="keyword">null</span>, filteredValues);</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;这行代码的作用主要是把下载的任务信息保存到数据库中，包括下载的URL、下载的控制状态、下载状态、总的文件大小、已下载的文件大小等默认的数据更新到数据库中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;这行代码的作用就是启动DownloadService服务。</p>
<p>&ensp;&ensp;当我们启动DownloadService之后，DownloadService服务的onCreate()数就会被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;  </div><div class="line"><span class="keyword">super</span>.onCreate();  </div><div class="line"><span class="keyword">if</span> (Constants.LOGVV) &#123;  </div><div class="line">    Log.v(Constants.TAG, <span class="string">"Service onCreate"</span>);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="keyword">if</span> (mSystemFacade == <span class="keyword">null</span>) &#123;  </div><div class="line">    mSystemFacade = <span class="keyword">new</span> RealSystemFacade(<span class="keyword">this</span>);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">mObserver = <span class="keyword">new</span> DownloadManagerContentObserver();  </div><div class="line">getContentResolver().registerContentObserver(  </div><div class="line">   Downloads.ALL_DOWNLOADS_CONTENT_URI, <span class="keyword">true</span>, mObserver);  </div><div class="line">  </div><div class="line">mNotifier = <span class="keyword">new</span> DownloadNotification(<span class="keyword">this</span>, mSystemFacade);  </div><div class="line">mSystemFacade.cancelAllNotifications();  </div><div class="line">  </div><div class="line">updateFromProvider();  </div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到，在onCreate()数中，会注册一个数据库变化监听器DownloadManagerContentObserver，就是说Downloads.ALL_DOWNLOADS_CONTENT_URI这个数据库的数据发生变化的时候，该监听器的监听函数onChange()会被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> selfChange)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (Constants.LOGVV) &#123;  </div><div class="line">   Log.v(Constants.TAG,  </div><div class="line">      <span class="string">"Service ContentObserver received notification"</span>);  </div><div class="line">    &#125;  </div><div class="line">    updateFromProvider();  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到onChange()函数会调用updateFromProvider()这个函数，从上面可以看到，onCreate()函数也会调到这个函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateFromProvider</span><span class="params">()</span> </span>&#123;  </div><div class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;  </div><div class="line">    mPendingUpdate = <span class="keyword">true</span>;  </div><div class="line">    <span class="keyword">if</span> (mUpdateThread == <span class="keyword">null</span>) &#123;  </div><div class="line">   mUpdateThread = <span class="keyword">new</span> UpdateThread();  </div><div class="line">   mSystemFacade.startThread(mUpdateThread);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到，updateFormProvider()函数其实就是会启动UpdateThread()这个线程。</p>
<p>&ensp;&ensp; 下面就进入到UpdateThread这个线程中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  </div><div class="line">  </div><div class="line">    trimDatabase();  </div><div class="line">    removeSpuriousFiles();  </div><div class="line">  </div><div class="line">    <span class="keyword">boolean</span> keepService = <span class="keyword">false</span>;  </div><div class="line">    <span class="comment">// for each update from the database, remember which download is  </span></div><div class="line">    <span class="comment">// supposed to get restarted soonest in the future  </span></div><div class="line">    <span class="keyword">long</span> wakeUp = Long.MAX_VALUE;  </div><div class="line">    <span class="keyword">for</span> (;;) &#123;  </div><div class="line">   <span class="keyword">synchronized</span> (DownloadService.<span class="keyword">this</span>) &#123;  </div><div class="line">       <span class="keyword">if</span> (mUpdateThread != <span class="keyword">this</span>) &#123;  </div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(  </div><div class="line">         <span class="string">"multiple UpdateThreads in DownloadService"</span>);  </div><div class="line">       &#125;  </div><div class="line">       <span class="keyword">if</span> (!mPendingUpdate) &#123;  </div><div class="line">      mUpdateThread = <span class="keyword">null</span>;  </div><div class="line">      <span class="keyword">if</span> (!keepService) &#123;  </div><div class="line">          stopSelf();  </div><div class="line">      &#125;  </div><div class="line">      <span class="keyword">if</span> (wakeUp != Long.MAX_VALUE) &#123;  </div><div class="line">          scheduleAlarm(wakeUp);  </div><div class="line">      &#125;  </div><div class="line">      <span class="keyword">return</span>;  </div><div class="line">       &#125;  </div><div class="line">       mPendingUpdate = <span class="keyword">false</span>;  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">   <span class="keyword">long</span> now = mSystemFacade.currentTimeMillis();  </div><div class="line">   keepService = <span class="keyword">false</span>;  </div><div class="line">   wakeUp = Long.MAX_VALUE;  </div><div class="line">   Set&lt;Long&gt; idsNoLongerInDatabase = <span class="keyword">new</span> HashSet&lt;Long&gt;(  </div><div class="line">      mDownloads.keySet());  </div><div class="line">  </div><div class="line">   Cursor cursor = getContentResolver().query(  </div><div class="line">      Downloads.ALL_DOWNLOADS_CONTENT_URI, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,  </div><div class="line">      <span class="keyword">null</span>);  </div><div class="line">   <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;  </div><div class="line">       <span class="keyword">continue</span>;  </div><div class="line">   &#125;  </div><div class="line">   <span class="keyword">try</span> &#123;  </div><div class="line">       DownloadInfo.Reader reader = <span class="keyword">new</span> DownloadInfo.Reader(  </div><div class="line">          getContentResolver(), cursor);  </div><div class="line">       <span class="keyword">int</span> idColumn = cursor.getColumnIndexOrThrow(Downloads._ID);  </div><div class="line">  </div><div class="line">       <span class="keyword">for</span> (cursor.moveToFirst(); !cursor.isAfterLast(); cursor  </div><div class="line">          .moveToNext()) &#123;  </div><div class="line">      <span class="keyword">long</span> id = cursor.getLong(idColumn);  </div><div class="line">      idsNoLongerInDatabase.remove(id);  </div><div class="line">      DownloadInfo info = mDownloads.get(id);  </div><div class="line">      <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;  </div><div class="line">          updateDownload(reader, info, now);  </div><div class="line">      &#125; <span class="keyword">else</span> &#123;  </div><div class="line">          info = insertDownload(reader, now);  </div><div class="line">      &#125;  </div><div class="line">      <span class="keyword">if</span> (info.hasCompletionNotification()) &#123;  </div><div class="line">          keepService = <span class="keyword">true</span>;  </div><div class="line">      &#125;  </div><div class="line">      <span class="keyword">long</span> next = info.nextAction(now);  </div><div class="line">      <span class="keyword">if</span> (next == <span class="number">0</span>) &#123;  </div><div class="line">          keepService = <span class="keyword">true</span>;  </div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next &gt; <span class="number">0</span> &amp;&amp; next &lt; wakeUp) &#123;  </div><div class="line">          wakeUp = next;  </div><div class="line">      &#125;  </div><div class="line">       &#125;  </div><div class="line">   &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">       cursor.close();  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">   <span class="keyword">for</span> (Long id : idsNoLongerInDatabase) &#123;  </div><div class="line">       deleteDownload(id);  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">   <span class="comment">// is there a need to start the DownloadService? yes, if there  </span></div><div class="line">   <span class="comment">// are rows to be deleted.  </span></div><div class="line">  </div><div class="line">   <span class="keyword">for</span> (DownloadInfo info : mDownloads.values()) &#123;  </div><div class="line">       <span class="keyword">if</span> (info.mDeleted) &#123;  </div><div class="line">      keepService = <span class="keyword">true</span>;  </div><div class="line">      <span class="keyword">break</span>;  </div><div class="line">       &#125;  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">   mNotifier.updateNotification(mDownloads.values());  </div><div class="line">  </div><div class="line">   <span class="comment">// look for all rows with deleted flag set and delete the rows  </span></div><div class="line">   <span class="comment">// from the database  </span></div><div class="line">   <span class="comment">// permanently  </span></div><div class="line">   <span class="keyword">for</span> (DownloadInfo info : mDownloads.values()) &#123;  </div><div class="line">       <span class="keyword">if</span> (info.mDeleted) &#123;  </div><div class="line">      Helpers.deleteFile(getContentResolver(), info.mId,  </div><div class="line">         info.mFileName, info.mMimeType);  </div><div class="line">       &#125;  </div><div class="line">   &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到UpdateThread这个线程也是很长，我们大概分析一下它的作用。</p>
<p>&ensp;&ensp; 可以看到这里有一个for(;;)的死循环，它的作用是保证数据库中的下载任务都会被加载出来，然后启动所有的下载任务，同时会更新下载任务，包括更新下载任务的状态，删除一些下载任务。</p>
<p>&ensp;&ensp; 它会从数据库中取出所有的下载任务，然后根据id从mDownloads集合中找到对应的下载任务，如果没找到就会新建一个下载任务DownloadInfo。然后就会调用updateDown()和insertDown()，启动下载任务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDownload</span><span class="params">(DownloadInfo.Reader reader, DownloadInfo info,  </span></span></div><div class="line">    <span class="keyword">long</span> now) &#123;  </div><div class="line"><span class="keyword">int</span> oldVisibility = info.mVisibility;  </div><div class="line"><span class="keyword">int</span> oldStatus = info.mStatus;  </div><div class="line">  </div><div class="line">reader.updateFromDatabase(info);  </div><div class="line">  </div><div class="line"><span class="keyword">boolean</span> lostVisibility = oldVisibility == Downloads.VISIBILITY_VISIBLE_NOTIFY_COMPLETED  </div><div class="line">   &amp;&amp; info.mVisibility != Downloads.VISIBILITY_VISIBLE_NOTIFY_COMPLETED  </div><div class="line">   &amp;&amp; Downloads.isStatusCompleted(info.mStatus);  </div><div class="line"><span class="keyword">boolean</span> justCompleted = !Downloads.isStatusCompleted(oldStatus)  </div><div class="line">   &amp;&amp; Downloads.isStatusCompleted(info.mStatus);  </div><div class="line"><span class="keyword">if</span> (lostVisibility || justCompleted) &#123;  </div><div class="line">    mSystemFacade.cancelNotification(info.mId);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">info.startIfReady(now);  </div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到该函数调用startIfReady()进行下载任务的启动。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">startIfReady</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (!isReadyToStart(now)) &#123;  </div><div class="line">        <span class="keyword">return</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (Constants.LOGV) &#123;  </div><div class="line">        Log.v(Constants.TAG, <span class="string">"Service spawning thread to handle download "</span> + mId);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span> (mHasActiveThread) &#123;  </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Multiple threads on same download"</span>);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span> (mStatus != Downloads.STATUS_RUNNING) &#123;  </div><div class="line">        mStatus = Downloads.STATUS_RUNNING;  </div><div class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();  </div><div class="line">        values.put(Downloads.COLUMN_STATUS, mStatus);  </div><div class="line">        mContext.getContentResolver().update(getAllDownloadsUri(), values, <span class="keyword">null</span>, <span class="keyword">null</span>);  </div><div class="line">        <span class="keyword">return</span>;  </div><div class="line">    &#125;  </div><div class="line">    DownloadThread downloader = <span class="keyword">new</span> DownloadThread(mContext, mSystemFacade, <span class="keyword">this</span>);  </div><div class="line">    mHasActiveThread = <span class="keyword">true</span>;  </div><div class="line">    mSystemFacade.startThread(downloader);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该函数是一个挺重要的函数，它会根据不同的情况判断下载任务是否需要启动。判断函数是isReadyToStart。这个函数十分关键，在我们要实现暂停下载，继续下载这个功能，都是在这里起作用的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReadyToStart</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (mHasActiveThread) &#123;  </div><div class="line">        <span class="comment">// already running  </span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span> (mControl == Downloads.CONTROL_PAUSED) &#123;  </div><div class="line">        <span class="comment">// the download is paused, so it's not going to start  </span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">switch</span> (mStatus) &#123;  </div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// status hasn't been initialized yet, this is a new download  </span></div><div class="line">        <span class="keyword">case</span> Downloads.STATUS_PENDING: <span class="comment">// download is explicit marked as ready to start  </span></div><div class="line">        <span class="keyword">case</span> Downloads.STATUS_RUNNING: <span class="comment">// download interrupted (process killed etc) while  </span></div><div class="line">                                            <span class="comment">// running, without a chance to update the database  </span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </div><div class="line">  </div><div class="line">        <span class="keyword">case</span> Downloads.STATUS_WAITING_FOR_NETWORK:  </div><div class="line">        <span class="keyword">case</span> Downloads.STATUS_QUEUED_FOR_WIFI:  </div><div class="line">            <span class="keyword">return</span> checkCanUseNetwork() == NETWORK_OK;  </div><div class="line">  </div><div class="line">        <span class="keyword">case</span> Downloads.STATUS_WAITING_TO_RETRY:  </div><div class="line">            <span class="comment">// download was waiting for a delayed restart  </span></div><div class="line">            <span class="keyword">return</span> restartTime(now) &lt;= now;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到，当下载任务正在进行，或者下载任务状态为暂停状态，或者网络状态是否正常，这时会返回false，就是没有准备好，就不会启动下载任务。当返回true的时候，就会把当前下载任务的状态刷新为Downloads.STATUS_RUNNING,同时会启动DownloadThread下载线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  </div><div class="line">  </div><div class="line">    State state = <span class="keyword">new</span> State(mInfo);  </div><div class="line">    PowerManager.WakeLock wakeLock = <span class="keyword">null</span>;  </div><div class="line">    <span class="keyword">int</span> finalStatus = Downloads.STATUS_UNKNOWN_ERROR;  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        PowerManager pm = (PowerManager) mContext  </div><div class="line">                .getSystemService(Context.POWER_SERVICE);  </div><div class="line">        wakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,  </div><div class="line">                Constants.TAG);  </div><div class="line">        wakeLock.acquire();  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (Constants.LOGV) &#123;  </div><div class="line">            Log.v(Constants.TAG, <span class="string">"initiating download for "</span> + mInfo.mUri);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">        <span class="keyword">boolean</span> finished = <span class="keyword">false</span>;  </div><div class="line">        <span class="keyword">while</span> (!finished) &#123;  </div><div class="line">            Log.i(Constants.TAG, <span class="string">"Initiating request for download "</span>  </div><div class="line">                    + mInfo.mId);  </div><div class="line">  </div><div class="line">  </div><div class="line">            Request.Builder requestBuilder = <span class="keyword">new</span> Request.Builder();  </div><div class="line">            InnerState innerState = <span class="keyword">new</span> InnerState();  </div><div class="line">            setupDestinationFile(state, innerState);  </div><div class="line">            addRequestHeaders(innerState, requestBuilder);  </div><div class="line">            requestBuilder.url(state.mRequestUri);  </div><div class="line">  </div><div class="line">            Request request = requestBuilder.build();  </div><div class="line">            Call call = mOkHttpClient.newCall(request);  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                executeDownload(innerState, state, call);  </div><div class="line">                finished = <span class="keyword">true</span>;  </div><div class="line">            &#125; <span class="keyword">catch</span> (RetryDownload exc) &#123;  </div><div class="line">                <span class="comment">// fall through  </span></div><div class="line">            &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                call.cancel();  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (Constants.LOGV) &#123;  </div><div class="line">            Log.v(Constants.TAG, <span class="string">"download completed for "</span> + mInfo.mUri);  </div><div class="line">        &#125;  </div><div class="line">        finalizeDestinationFile(state);  </div><div class="line">        finalStatus = Downloads.STATUS_SUCCESS;  </div><div class="line">    &#125; <span class="keyword">catch</span> (StopRequest error) &#123;  </div><div class="line">        <span class="comment">// remove the cause before printing, in case it contains PII  </span></div><div class="line">        Log.w(Constants.TAG, <span class="string">"Aborting request for download "</span> + mInfo.mId  </div><div class="line">                + <span class="string">": "</span> + error.getMessage());  </div><div class="line">        finalStatus = error.mFinalStatus;  </div><div class="line">        <span class="comment">// fall through to finally block  </span></div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123; <span class="comment">// sometimes the socket code throws unchecked  </span></div><div class="line">        <span class="comment">// exceptions  </span></div><div class="line">        Log.w(Constants.TAG, <span class="string">"Exception for id "</span> + mInfo.mId + <span class="string">": "</span> + ex);  </div><div class="line">        finalStatus = Downloads.STATUS_UNKNOWN_ERROR;  </div><div class="line">        <span class="comment">// falls through to the code that reports an error  </span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">        <span class="keyword">if</span> (wakeLock != <span class="keyword">null</span>) &#123;  </div><div class="line">            wakeLock.release();  </div><div class="line">            wakeLock = <span class="keyword">null</span>;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">if</span> (mOkHttpClient != <span class="keyword">null</span>) &#123;  </div><div class="line">            mOkHttpClient.cancel(<span class="keyword">null</span>);  </div><div class="line">        &#125;  </div><div class="line">        cleanupDestination(state, finalStatus);  </div><div class="line">        notifyDownloadCompleted(finalStatus, state.mCountRetry,  </div><div class="line">                state.mRetryAfter, state.mGotData, state.mFilename,  </div><div class="line">                state.mNewUri, state.mMimeType);  </div><div class="line">        mInfo.mHasActiveThread = <span class="keyword">false</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setupDestinationFile(state, innerState);</div></pre></td></tr></table></figure></p>
<p>这个方法是实现断点续传的关键点。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupDestinationFile</span><span class="params">(State state, InnerState innerState)</span>  </span></div><div class="line">        <span class="keyword">throws</span> StopRequest &#123;  </div><div class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(state.mFilename)) &#123; <span class="comment">// only true if we've already  </span></div><div class="line">        <span class="comment">// run a thread for this  </span></div><div class="line">        <span class="comment">// download  </span></div><div class="line">        <span class="keyword">if</span> (!Helpers.isFilenameValid(state.mFilename)) &#123;  </div><div class="line">            <span class="comment">// this should never happen  </span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_FILE_ERROR,  </div><div class="line">                    <span class="string">"found invalid internal destination filename"</span>);  </div><div class="line">        &#125;  </div><div class="line">        <span class="comment">// We're resuming a download that got interrupted  </span></div><div class="line">        File f = <span class="keyword">new</span> File(state.mFilename);  </div><div class="line">        <span class="keyword">if</span> (f.exists()) &#123;  </div><div class="line">            <span class="keyword">long</span> fileLength = f.length();  </div><div class="line">            <span class="keyword">if</span> (fileLength == <span class="number">0</span>) &#123;  </div><div class="line">                <span class="comment">// The download hadn't actually started, we can restart from  </span></div><div class="line">                <span class="comment">// scratch  </span></div><div class="line">                f.delete();  </div><div class="line">                state.mFilename = <span class="keyword">null</span>;  </div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInfo.mETag == <span class="keyword">null</span> &amp;&amp; !mInfo.mNoIntegrity) &#123;  </div><div class="line">                <span class="comment">// This should've been caught upon failure  </span></div><div class="line">                f.delete();  </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_CANNOT_RESUME,  </div><div class="line">                        <span class="string">"Trying to resume a download that can't be resumed"</span>);  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                <span class="comment">// All right, we'll be able to resume this download  </span></div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    state.mStream = <span class="keyword">new</span> FileOutputStream(state.mFilename,  </div><div class="line">                            <span class="keyword">true</span>);  </div><div class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException exc) &#123;  </div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_FILE_ERROR,  </div><div class="line">                            <span class="string">"while opening destination for resuming: "</span>  </div><div class="line">                                    + exc.toString(), exc);  </div><div class="line">                &#125;  </div><div class="line">                innerState.mBytesSoFar = (<span class="keyword">int</span>) fileLength;  </div><div class="line">                <span class="keyword">if</span> (mInfo.mTotalBytes != -<span class="number">1</span>) &#123;  </div><div class="line">                    innerState.mHeaderContentLength = Long  </div><div class="line">                            .toString(mInfo.mTotalBytes);  </div><div class="line">                &#125;  </div><div class="line">                innerState.mHeaderETag = mInfo.mETag;  </div><div class="line">                innerState.mContinuingDownload = <span class="keyword">true</span>;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (state.mStream != <span class="keyword">null</span>  </div><div class="line">            &amp;&amp; mInfo.mDestination == Downloads.DESTINATION_EXTERNAL) &#123;  </div><div class="line">        closeDestination(state);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 方法的流程大概是：先根据文件名建立一个文件对象，判断文件对象是否存在，如果存在再判断文件的大小，当文件大小为0的时候，把文件删除。同时，会把当前的文件的输出流保存到state.mStream，把当前文件的长度、要下载文件的总长度、文件继续下载状态保存到innerState中。<br>&ensp;&ensp; 再分析addRequestHeader（）方法，该方法也是实现断点续传的关键。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addRequestHeaders</span><span class="params">(InnerState innerState, Request.Builder requestBuilder)</span> </span>&#123;  </div><div class="line">    <span class="keyword">for</span> (Pair&lt;String, String&gt; header : mInfo.getHeaders()) &#123;  </div><div class="line">        requestBuilder.addHeader(header.first, header.second);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (innerState.mContinuingDownload) &#123;  </div><div class="line">        <span class="keyword">if</span> (innerState.mHeaderETag != <span class="keyword">null</span>) &#123;  </div><div class="line">            requestBuilder.addHeader(<span class="string">"If-Match"</span>, mInfo.mETag);  </div><div class="line">        &#125;  </div><div class="line">        requestBuilder.addHeader(<span class="string">"Range"</span>, <span class="string">"bytes="</span> + innerState.mBytesSoFar + <span class="string">"-"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该方法会把请求头添加到请求中，最重要的是：如果是断点续传的话，会把当前的文件大小也放到请求头中，这样服务器就会知道当前的文件已经下载了多少。</p>
<p>&ensp;&ensp; 下面来分析最重要的executeDownload方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeDownload</span><span class="params">(InnerState innerState, State state, Call call)</span> <span class="keyword">throws</span> StopRequest, RetryDownload, IOException </span>&#123;  </div><div class="line">    <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[Constants.BUFFER_SIZE];  </div><div class="line">  </div><div class="line">  </div><div class="line">    <span class="comment">// check just before sending the request to avoid using an invalid  </span></div><div class="line">    <span class="comment">// connection at all  </span></div><div class="line">    checkConnectivity(state);  </div><div class="line">  </div><div class="line">    Response response = call.execute();  </div><div class="line">    handleExceptionalStatus(state, innerState, response);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (Constants.LOGV) &#123;  </div><div class="line">        Log.v(Constants.TAG, <span class="string">"received response for "</span> + mInfo.mUri);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    processResponseHeaders(state, innerState, response);  </div><div class="line">    InputStream entityStream = openResponseEntity(state, response);  </div><div class="line">    transferData(state, innerState, data, entityStream);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到这个下载工具用到okhttp这个开源库进行网络的请求。使用okhttp得到了Response对象。</p>
<ul>
<li>先分析processResponseHeaders（）这个方法，这个方法中会获取Http请求的header，同时，根据这次下载是否为断点下载，如果是则返回，如果不是，则会把要下载的文件的输入流对象保存到state.mStream变量中。</li>
<li>再分析openResponseEntity()这个方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> InputStream <span class="title">openResponseEntity</span><span class="params">(State state, Response response)</span>  </span></div><div class="line">        <span class="keyword">throws</span> StopRequest &#123;  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        <span class="keyword">return</span> response.body().byteStream();  </div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;  </div><div class="line">        logNetworkState();  </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(getFinalStatusForHttpError(state),  </div><div class="line">                <span class="string">"while getting entity: "</span> + ex.toString(), ex);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&ensp;&ensp; 该方法是获取Response对象的输出流变量,最后是transferData（）方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">transferData</span><span class="params">(State state, InnerState innerState, <span class="keyword">byte</span>[] data,  </span></span></div><div class="line">                          InputStream entityStream) <span class="keyword">throws</span> StopRequest &#123;  </div><div class="line">    <span class="keyword">for</span> (; ; ) &#123;  </div><div class="line">        <span class="keyword">int</span> bytesRead = readFromResponse(state, innerState, data,  </div><div class="line">                entityStream);  </div><div class="line">        <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123; <span class="comment">// success, end of stream already reached  </span></div><div class="line">            handleEndOfStream(state, innerState);  </div><div class="line">            <span class="keyword">return</span>;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        state.mGotData = <span class="keyword">true</span>;  </div><div class="line">        writeDataToDestination(state, data, bytesRead);  </div><div class="line">        innerState.mBytesSoFar += bytesRead;  </div><div class="line">        reportProgress(state, innerState);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (Constants.LOGVV) &#123;  </div><div class="line">            Log.v(Constants.TAG, <span class="string">"downloaded "</span> + innerState.mBytesSoFar  </div><div class="line">                    + <span class="string">" for "</span> + mInfo.mUri);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        checkPausedOrCanceled(state);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到，这是一个for(;;)死循环，用于读取下载的文件流。</p>
<ul>
<li>先调用readFromResponse()函数，从文件输出流中读取数据，保存到data字节数组中。</li>
<li>然后调用writeDataToDestination()数，把data字节数组中的数据写到本地的文件中。</li>
<li>然后调用reportProgress()数，把已下载的文件的大小更新到数据库中。用于更新进度条的显示。</li>
</ul>
<p>&ensp;&ensp; 可以看到checkPauseOrCanceled()数。这是实现暂停下载的关键函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPausedOrCanceled</span><span class="params">(State state)</span> <span class="keyword">throws</span> StopRequest </span>&#123;  </div><div class="line">    <span class="keyword">synchronized</span> (mInfo) &#123;  </div><div class="line">        <span class="keyword">if</span> (mInfo.mControl == Downloads.CONTROL_PAUSED) &#123;  </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_PAUSED_BY_APP,  </div><div class="line">                    <span class="string">"download paused by owner"</span>);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span> (mInfo.mStatus == Downloads.STATUS_CANCELED) &#123;  </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_CANCELED,  </div><div class="line">                <span class="string">"download canceled"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以分析，这里会根据下载任务的当前状态进行判断，如果当前的任务状态被更改为Downloads.CONTROL_PAUSED时，就会抛出StopRequest的异常，当前的文件下载就会被终止，这样就可以实现暂停下载了。</p>
<p> 到此为止，DownloadManager下载的整个流程就分析完了。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>&ensp;&ensp;通过上面的分析，我们几乎理解了DownloadManager的整个工作流程。在我们下载文件的时候，我们几乎都是需要暂停下载和继续下载还有断点续传的功能。DownloadProvider代码是可以让我们能够实现这个功能了。</p>
<p>&ensp;&ensp;实现断点续传的原理其实就是我们每次添加下载任务，都会把任务的信息保存到数据库中，包括下载的URL，已下载的文件大小，总的文件大小。下次我们再进行下载的时候，把已下载的大小传到服务器中，就可以从上一次已下载的文件的基础上继续下载，就可以实现断点下载了。</p>
<p>&ensp;&ensp;暂停下载和继续下载的实现，其实只需要更新下载任务的状态就可以实现了。因为从上面的下载可以知道，在下载文件的过程中，都会检验当前的下载任务的状态，若是暂停状态，就会停止下载，跳出死循环。当我们再次改变状态为继续下载时，下载任务会被再次启动。</p>
<p>来源：<br><a href="http://blog.csdn.net/carrey1989/article/details/8060155" target="_blank" rel="external">http://blog.csdn.net/carrey1989/article/details/8060155</a><br><a href="http://blog.csdn.net/garment1991/article/details/54178557" target="_blank" rel="external">http://blog.csdn.net/garment1991/article/details/54178557</a><br><a href="http://www.trinea.cn/android/android-downloadmanager-pro/" target="_blank" rel="external">http://www.trinea.cn/android/android-downloadmanager-pro/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cattlefoot.github.io/2017/06/19/android-download-manager使用/" data-id="cjhrczp3k0004lvs6peze9h9k" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Download-Manager/">Download Manager</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/03/rxjava2基础/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          rxjava2基础
        
      </div>
    </a>
  
  
    <a href="/2017/06/21/Bitmap压缩/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">Bitmap压缩</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/7/">7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bitmap/">Bitmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BitmapFactory/">BitmapFactory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Download-Manager/">Download Manager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DynamicLoadApk/">DynamicLoadApk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Instant-Run/">Instant Run</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC-MVP-MVVM/">MVC MVP MVVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MulitiDex/">MulitiDex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NestedScrolling/">NestedScrolling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Options/">Options</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Small/">Small</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Support/">Support</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tool/">Tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/7/" style="font-size: 10px;">7</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Bitmap/" style="font-size: 10px;">Bitmap</a> <a href="/tags/BitmapFactory/" style="font-size: 10px;">BitmapFactory</a> <a href="/tags/Download-Manager/" style="font-size: 15px;">Download Manager</a> <a href="/tags/DynamicLoadApk/" style="font-size: 10px;">DynamicLoadApk</a> <a href="/tags/Instant-Run/" style="font-size: 10px;">Instant Run</a> <a href="/tags/MVC-MVP-MVVM/" style="font-size: 10px;">MVC MVP MVVM</a> <a href="/tags/MulitiDex/" style="font-size: 10px;">MulitiDex</a> <a href="/tags/NestedScrolling/" style="font-size: 10px;">NestedScrolling</a> <a href="/tags/Options/" style="font-size: 10px;">Options</a> <a href="/tags/Small/" style="font-size: 10px;">Small</a> <a href="/tags/Support/" style="font-size: 10px;">Support</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/git/" style="font-size: 10px;">git</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/15/mvc-mvp和mvvm理解/">mvc_mvp和mvvm理解</a>
          </li>
        
          <li>
            <a href="/2017/06/28/插件化种种和思考/">插件化种种和思考</a>
          </li>
        
          <li>
            <a href="/2017/06/28/nestedscollin原理/">nestedscollin原理</a>
          </li>
        
          <li>
            <a href="/2017/06/24/downloadManagerSupport7-0/">downloadManagerSupport7.0</a>
          </li>
        
          <li>
            <a href="/2017/06/24/git命令和使用/">git命令和使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 CallteFoot<br>
      Propulsé by <a href="https://cattlefoot.github.io" target="_blank">CallteFoot</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>