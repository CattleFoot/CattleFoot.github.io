<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.svg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.svg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.svg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,Download Manager," />










<meta name="description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta name="keywords" content="Android,Download Manager">
<meta property="og:type" content="article">
<meta property="og:title" content="android_download_manager使用">
<meta property="og:url" content="https://cattlefoot.github.io/2017/06/19/android-download-manager使用/index.html">
<meta property="og:site_name" content="CallteFoot&#39;s blog">
<meta property="og:description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://cattlefoot.github.io/images/DownloadManager.png">
<meta property="og:updated_time" content="2019-01-19T07:22:07.135Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android_download_manager使用">
<meta name="twitter:description" content="&amp;ensp;&amp;ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理HTTP/HTTPS连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。&amp;ensp;&amp;ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别">
<meta name="twitter:image" content="https://cattlefoot.github.io/images/DownloadManager.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://cattlefoot.github.io/2017/06/19/android-download-manager使用/"/>





  <title>android_download_manager使用 | CallteFoot's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CallteFoot's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Victory belongs to the most persevering</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://cattlefoot.github.io/2017/06/19/android-download-manager使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CallteFoot">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CallteFoot's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">android_download_manager使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-19T22:51:02+08:00">
                2017-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&ensp;&ensp;从Android 2.3（Api level 9）开始Android用系统服务的方式提供了Download Manager来优化处理长时间的下载操作。Download Manager处理<strong>HTTP/HTTPS</strong>连接并监控连接中的状态变化以及重启来确保每一个下载任务顺利完成。<br>&ensp;&ensp;在大多数涉及到下载的情况中使用Download Manager都是不错的选择，特别是当用户切换不同的应用以后下载需要在后台继续进行，以及当下载任务顺利完成非常重要的情况（DownloadManager对于断点续传功能支持很好）。<br>&ensp;&ensp;要想使用Download Manager，使用getSystemService方法请求系统的DOWNLOAD_SERVICE服务，代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String serviceString = Context.DOWNLOAD_SERVICE;  </span><br><span class="line">DownloadManager downloadManager;  </span><br><span class="line">downloadManager = (DownloadManager) getSystemService(serviceString);</span><br></pre></td></tr></table></figure></p>
<h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><p>&ensp;&ensp;需要一个请求下载操作，创建一个DownloadManager.Request对象，将要请求下载的文件的Uri传递给Download Manager的enqueue方法，代码片段如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(<span class="string">"http://developer.android.com/shareables/icon_templates-v4.0.zip"</span>);  </span><br><span class="line">DownloadManager.Request request = <span class="keyword">new</span> Request(uri);  </span><br><span class="line"><span class="keyword">long</span> reference = downloadManager.enqueue(request);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;在这里返回的reference变量是系统为当前的下载请求分配的一个唯一的ID，我们可以通过这个ID重新获得这个下载任务，进行一些自己想要进行的操作或者查询下载的状态以及取消下载等等。</p>
<p>&ensp;&ensp;我们可以通过addRequestHeader方法为DownloadManager.Request对象request添加HTTP头，也可以通过setMimeType方法重写从服务器返回的mime type。</p>
<p>&ensp;&ensp;我们还可以指定在什么连接状态下执行下载操作。setAllowedNetworkTypes方法可以用来限定在WiFi还是手机网络下进行下载，setAllowedOverRoaming方法可以用来阻止手机在漫游状态下下载。</p>
<p>&ensp;&ensp;下面的代码片段用于指定一个较大的文件只能在WiFi下进行下载：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.setAllowedNetworkTypes(Request.NETWORK_WIFI);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;Android API level 11 介绍了getRecommendedMaxBytesOverMobile类方法（静态方法），返回一个当前手机网络连接下的最大建议字节数，可以来判断下载是否应该限定在WiFi条件下。</p>
<p>&ensp;&ensp;调用enqueue方法之后，只要数据连接可用并且Download Manager可用，下载就会开始。</p>
<p>&ensp;&ensp;要在下载完成的时候获得一个系统通知（notification）,注册一个广播接受者来接收<strong>ACTION_DOWNLOAD_COMPLETE</strong>广播，这个广播会包含一个<br><strong>EXTRA_DOWNLOAD_ID</strong>信息在intent中包含了已经完成的这个下载的ID,代码片段如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter filter = <span class="keyword">new</span> IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE);       </span><br><span class="line">BroadcastReceiver receiver = <span class="keyword">new</span> BroadcastReceiver() &#123;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">long</span> reference = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -<span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">if</span> (myDownloadReference == reference) &#123;  </span><br><span class="line">      <span class="comment">//do something</span></span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line">registerReceiver(receiver, filter);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;使用Download Manager的openDownloadedFile方法可以打开一个已经下载完成的文件，返回一个ParcelFileDescriptor对象。我们可以通过Download Manager来查询下载文件的保存地址，如果在下载时制定了路径和文件名，我们也可以直接操作文件。</p>
<p>&ensp;&ensp;我们可以为<strong>ACTION_NOTIFICATION_CLICKED</strong> action注册一个广播接受者，当用户从通知栏点击了一个下载项目或者从Downloads app点击可一个下载的项目的时候，系统就会发出一个点击下载项的广播。<br>代码片段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter filter = <span class="keyword">new</span> IntentFilter(DownloadManager.ACTION_NOTIFICATION_CLICKED);    </span><br><span class="line">BroadcastReceiver receiver = <span class="keyword">new</span> BroadcastReceiver() &#123;  </span><br><span class="line">  <span class="meta">@Override</span>  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </span><br><span class="line">    String extraID = DownloadManager.EXTRA_NOTIFICATION_CLICK_DOWNLOAD_IDS;  </span><br><span class="line">    <span class="keyword">long</span>[] references = intent.getLongArrayExtra(extraID);  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> reference : references)  </span><br><span class="line">      <span class="keyword">if</span> (reference == myDownloadReference) &#123;  </span><br><span class="line">        <span class="comment">// Do something with downloading file.  </span></span><br><span class="line">      &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line">registerReceiver(receiver, filter);</span><br></pre></td></tr></table></figure></p>
<h3 id="定制Download-Manager-Notifications的样式"><a href="#定制Download-Manager-Notifications的样式" class="headerlink" title="定制Download Manager Notifications的样式"></a>定制Download Manager Notifications的样式</h3><p>&ensp;&ensp;默认情况下，通知栏中会显示被Download Manager管理的每一个download每一个Notification会显示当前的下载进度和文件的名字。通过Download Manager可以为每一个download request定制Notification的样式，包括完全隐藏Notification。下面的代码片段显示了通过setTitle和setDescription方法来定制显示在文件下载Notification中显示的文字（下载的通知icon不可更改？）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setTitle(“Earthquakes”);  </span><br><span class="line">request.setDescription(“Earthquake XML”);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;request.setNotificationVisibility方法可以用来控制什么时候显示Notification，甚至隐藏该request的Notification。有以下几个参数：</p>
<ol>
<li>Request.VISIBILITY_VISIBLE：在下载进行的过程中，通知栏中会一直显示该下载的Notification，当下载完成时，该Notification会被移除，这是默认的参数值；</li>
<li>Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED：在下载过程中通知栏会一直显示该下载的Notification，在下载完成后该Notification会继续显示，直到用户点击该Notification或者消除该Notification；</li>
<li>Request.VISIBILITY_VISIBLE_NOTIFY_ONLY_COMPLETION：只有在下载完成后该Notification才会被显示；</li>
<li>Request.VISIBILITY_HIDDEN：不显示该下载请求的Notification。如果要使用这个参数，需要在应用的清单文件中加上DOWNLOAD_WITHOUT_NOTIFICATION权限。</li>
</ol>
<h3 id="指定下载保存地址"><a href="#指定下载保存地址" class="headerlink" title="指定下载保存地址"></a>指定下载保存地址</h3><p>&ensp;&ensp;默认情况下，所有通过Download Manager下载的文件都保存在一个共享下载缓存中，使用系统生成的文件名每一个Request对象都可以制定一个下载保存的地址，通常情况下，所有的下载文件都应该保存在外部存储中，所以我们需要在应用清单文件中加上WRITE_EXTERNAL_STORAGE权限：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=”android.permission.WRITE_EXTERNAL_STORAGE”/&gt;</span><br></pre></td></tr></table></figure></p>
<p> 下面的代码片段是在外部存储中指定一个任意的保存位置的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.setDestinationUri(Uri.fromFile(f));   <span class="comment">// f是一个File对象</span></span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;如果下载的这个文件是你的应用所专用的，你可能会希望把这个文件放在你的应用在外部存储中的一个专有文件夹中。注意这个文件夹不提供访问控制，所以其他的应用也可以访问这个文件夹。在这种情况下，如果你的应用卸载了，那么在这个文件夹也会被删除。<br>&ensp;&ensp;下面的代码片段是指定存储文件的路径是应用在外部存储中的专用文件夹的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setDestinationInExternalFilesDir(<span class="keyword">this</span>,  </span><br><span class="line">  Environment.DIRECTORY_DOWNLOADS, “Bugdroid.png”);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;如果下载的文件希望被其他的应用共享，特别是那些你下载下来希望被Media Scanner扫描到的文件（比如音乐文件），那么你可以指定你的下载路径在外部存储的公共文件夹之下，下面的代码片段是将文件存放到外部存储中的公共音乐文件夹的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setDestinationInExternalPublicDir(Environment.DIRECTORY_MUSIC,  </span><br><span class="line">     <span class="string">"Android_Rock.mp3"</span>);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;在默认的情况下，通过Download Manager下载的文件是不能被Media Scanner扫描到的，进而这些下载的文件（音乐、视频等）就不会在Gallery和Music Player这样的应用中看到。为了让下载的音乐文件可以被其他应用扫描到，我们需要调用Request对象的allowScaningByMediaScanner方法。如果我们希望下载的文件可以被系统的Downloads应用扫描到并管理，我们需要调用Request对象的setVisibleInDownloadsUi方法，传递参数true。</p>
<h3 id="取消或删除下载"><a href="#取消或删除下载" class="headerlink" title="取消或删除下载"></a>取消或删除下载</h3><p>&ensp;&ensp;Download Manager的remove方法可以用来取消一个准备进行的下载，中止一个正在进行的下载，或者删除一个已经完成的下载。remove方法接受若干个download 的ID作为参数，你可以设置一个或者几个你想要取消的下载的ID，如下代码段所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">downloadManager.remove(REFERENCE_1, REFERENCE_2, REFERENCE_3);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该方法返回成功取消的下载的个数，如果一个下载被取消了，所有相关联的文件，部分下载的文件和完全下载的文件都会被删除。</p>
<h3 id="查询Download-Manager"><a href="#查询Download-Manager" class="headerlink" title="查询Download Manager"></a>查询Download Manager</h3><p>&ensp;&ensp;你可以通过查询Download Manager来获得下载任务的状态，进度，以及各种细节，通过query方法返回一个包含了下载任务细节的Cursor。query方法传递一个DownloadManager.Query对象作为参数，通过DownloadManager.Query对象的setFilterById方法可以筛选我们希望查询的下载任务的ID。也可以使用setFilterByStatus方法筛选我们希望查询的某一种状态的下载任务，传递的参数是DownloadManager.STATUS<em><em>常量，可以指定正在<em>*进行、暂停、失败、完成</em></em>四种状态。Download Manager包含了一系列COLUMN</em><em>静态String常量，可以用来查询Cursor中的结果列索引。我们可以查询到下载任务的各种细节，包括<em>*状态，文件大小，已经下载的字节数，标题，描述，URI，本地文件名和URI，媒体类型以及Media Provider download URI</em></em>。</p>
<p>&ensp;&ensp;下面的代码段是通过注册监听下载完成事件的广播接受者来查询下载完成文件的本地文件名和URI的实现方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;  </span><br><span class="line">      <span class="keyword">long</span> reference = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -<span class="number">1</span>);  </span><br><span class="line">      <span class="keyword">if</span> (myDownloadReference == reference) &#123;  </span><br><span class="line">        Query myDownloadQuery = <span class="keyword">new</span> Query();  </span><br><span class="line">        myDownloadQuery.setFilterById(reference);  </span><br><span class="line">        Cursor myDownload = downloadManager.query(myDownloadQuery);  </span><br><span class="line">        <span class="keyword">if</span> (myDownload.moveToFirst()) &#123;</span><br><span class="line">        <span class="comment">//文件名称索引  </span></span><br><span class="line">          <span class="keyword">int</span> fileNameIdx =   </span><br><span class="line">     myDownload.getColumnIndex(DownloadManager.COLUMN_LOCAL_FILENAME);</span><br><span class="line">     <span class="comment">//下载文件存放地址uri索引</span></span><br><span class="line">          <span class="keyword">int</span> fileUriIdx =   </span><br><span class="line">myDownload.getColumnIndex(DownloadManager.COLUMN_LOCAL_URI);  </span><br><span class="line"><span class="comment">//下载状态</span></span><br><span class="line">            <span class="keyword">int</span> status = cursor.getInt(cursor.getColumnIndex(DownloadManager.COLUMN_STATUS));  </span><br><span class="line">             <span class="keyword">switch</span> (status) &#123;  </span><br><span class="line">            <span class="keyword">case</span> DownloadManager.STATUS_PAUSED:  </span><br><span class="line">                statusMsg = <span class="string">"STATUS_PAUSED"</span>;  </span><br><span class="line">            <span class="keyword">case</span> DownloadManager.STATUS_PENDING:  </span><br><span class="line">                statusMsg = <span class="string">"STATUS_PENDING"</span>;  </span><br><span class="line">            <span class="keyword">case</span> DownloadManager.STATUS_RUNNING:  </span><br><span class="line">                statusMsg = <span class="string">"STATUS_RUNNING"</span>;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> DownloadManager.STATUS_SUCCESSFUL:  </span><br><span class="line">                statusMsg = <span class="string">"STATUS_SUCCESSFUL"</span>;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> DownloadManager.STATUS_FAILED:  </span><br><span class="line">                statusMsg = <span class="string">"STATUS_FAILED"</span>;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:  </span><br><span class="line">                statusMsg = <span class="string">"未知状态"</span>;  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">          String fileName = myDownload.getString(fileNameIdx);  </span><br><span class="line">          String fileUri = myDownload.getString(fileUriIdx);  </span><br><span class="line">          <span class="comment">// TODO Do something with the file.  </span></span><br><span class="line">          Log.d(TAG, fileName + <span class="string">" : "</span> + fileUri);  </span><br><span class="line">        &#125;  </span><br><span class="line">        myDownload.close();  </span><br><span class="line">      &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;对于暂停和失败的下载，我们可以通过查询COLUMN_REASON列查询出原因的整数码。</p>
<ol>
<li>对于STATUS<em>PAUSED状态的下载，可以通过DownloadManager.PAUSED</em>* 静态常量来翻译出原因的整数码，进而判断出下载是由于等待网络连接还是等待WiFi连接还是准备重新下载三种原因而暂停。</li>
<li>对于STATUS<em>FAILED状态的下载，我们可以通过DownloadManager.ERROR</em>*来判断失败的原因，可能是错误码（失败原因）包括没有存储设备，存储空间不足，重复的文件名，或者HTTP errors。<br>&ensp;&ensp;下面的代码是如何查询出当前所有的暂停的下载任务，提取出暂停的原因以及文件名称，下载标题以及当前进度的实现方法：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Obtain the Download Manager Service.  </span></span><br><span class="line">String serviceString = Context.DOWNLOAD_SERVICE;  </span><br><span class="line">DownloadManager downloadManager;  </span><br><span class="line">downloadManager = (DownloadManager)getSystemService(serviceString);  </span><br><span class="line"><span class="comment">// Create a query for paused downloads.  </span></span><br><span class="line">Query pausedDownloadQuery = <span class="keyword">new</span> Query();  </span><br><span class="line">pausedDownloadQuery.setFilterByStatus(DownloadManager.STATUS_PAUSED);  </span><br><span class="line"><span class="comment">// Query the Download Manager for paused downloads.  </span></span><br><span class="line">Cursor pausedDownloads = downloadManager.query(pausedDownloadQuery);  </span><br><span class="line"><span class="comment">// Find the column indexes for the data we require.  </span></span><br><span class="line"><span class="keyword">int</span> reasonIdx = pausedDownloads.getColumnIndex(DownloadManager.COLUMN_REASON);  </span><br><span class="line"><span class="keyword">int</span> titleIdx = pausedDownloads.getColumnIndex(DownloadManager.COLUMN_TITLE);  </span><br><span class="line"><span class="keyword">int</span> fileSizeIdx =   </span><br><span class="line"> pausedDownloads.getColumnIndex(DownloadManager.COLUMN_TOTAL_SIZE_BYTES);      </span><br><span class="line"><span class="keyword">int</span> bytesDLIdx =   </span><br><span class="line">pausedDownloads.getColumnIndex(DownloadManager.COLUMN_BYTES_DOWNLOADED_SO_FAR);  </span><br><span class="line"><span class="comment">// Iterate over the result Cursor.  </span></span><br><span class="line"><span class="keyword">while</span> (pausedDownloads.moveToNext()) &#123;  </span><br><span class="line">  <span class="comment">// Extract the data we require from the Cursor.  </span></span><br><span class="line">  String title = pausedDownloads.getString(titleIdx);  </span><br><span class="line">  <span class="keyword">int</span> fileSize = pausedDownloads.getInt(fileSizeIdx);  </span><br><span class="line">  <span class="keyword">int</span> bytesDL = pausedDownloads.getInt(bytesDLIdx);  </span><br><span class="line">  <span class="comment">// Translate the pause reason to friendly text.  </span></span><br><span class="line">  <span class="keyword">int</span> reason = pausedDownloads.getInt(reasonIdx);  </span><br><span class="line">  String reasonString = <span class="string">"Unknown"</span>;  </span><br><span class="line">  <span class="keyword">switch</span> (reason) &#123;  </span><br><span class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_QUEUED_FOR_WIFI :   </span><br><span class="line">      reasonString = <span class="string">"Waiting for WiFi"</span>; <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_WAITING_FOR_NETWORK :   </span><br><span class="line">      reasonString = <span class="string">"Waiting for connectivity"</span>; <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> DownloadManager.PAUSED_WAITING_TO_RETRY :  </span><br><span class="line">      reasonString = <span class="string">"Waiting to retry"</span>; <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">default</span> : <span class="keyword">break</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="comment">// Construct a status summary  </span></span><br><span class="line">  StringBuilder sb = <span class="keyword">new</span> StringBuilder();  </span><br><span class="line">  sb.append(title).append(<span class="string">"\n"</span>);  </span><br><span class="line">  sb.append(reasonString).append(<span class="string">"\n"</span>);  </span><br><span class="line">  sb.append(<span class="string">"Downloaded "</span>).append(bytesDL).append(<span class="string">" / "</span> ).append(fileSize);  </span><br><span class="line">  <span class="comment">// Display the status   </span></span><br><span class="line">  Log.d(<span class="string">"DOWNLOAD"</span>, sb.toString());  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// Close the result Cursor.  </span></span><br><span class="line">pausedDownloads.close();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="DownloadManager原理"><a href="#DownloadManager原理" class="headerlink" title="DownloadManager原理"></a>DownloadManager原理</h3><p>&ensp;&ensp;通过介绍我们已经可以灵活的使用DownloadManaged为我们服务了，为了更好的使用这个工具，得先了解它的工作原理、工作流程。下面就是整个工作流程的时序图：<br><img src="/images/DownloadManager.png" alt="Download Manager时序图"><br>&ensp;&ensp;从上面的时序图我们可以大致了解整个流程。从添加请求，到最后开启下载线程进行文件的下载。为了更好的理解这个下载工具的思想，下面将从源码上对一些重要的函数进行分析。</p>
<p>&ensp;&ensp;一开始，调用DownloadManager的enqueue()法进行下载请求的添加，然后就会调用DownloadProvider的insert()方法进行数据库的数据的插入，insert()不单单是把数据插入到数据库，还会启动DownloadService这个服务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(<span class="keyword">final</span> Uri uri, <span class="keyword">final</span> ContentValues values)</span> </span>&#123;  </span><br><span class="line">    checkInsertPermissions(values);  </span><br><span class="line">    SQLiteDatabase db = mOpenHelper.getWritableDatabase();  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// note we disallow inserting into ALL_DOWNLOADS  </span></span><br><span class="line">       <span class="keyword">if</span> (pckg != <span class="keyword">null</span> &amp;&amp; (clazz != <span class="keyword">null</span> || isPublicApi)) &#123;  </span><br><span class="line">        <span class="keyword">int</span> uid = Binder.getCallingUid();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (uid == <span class="number">0</span> || mSystemFacade.userOwnsPackage(uid, pckg)) &#123;  </span><br><span class="line">                filteredValues.put(Downloads.COLUMN_NOTIFICATION_PACKAGE,  </span><br><span class="line">                        pckg);  </span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                    filteredValues.put(Downloads.COLUMN_NOTIFICATION_CLASS,  </span><br><span class="line">                            clazz);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException ex) &#123;  </span><br><span class="line">    <span class="comment">/* ignored for now */</span>  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    copyString(Downloads.COLUMN_NOTIFICATION_EXTRAS, values, filteredValues);  </span><br><span class="line">    copyString(Downloads.COLUMN_COOKIE_DATA, values, filteredValues);  </span><br><span class="line">    copyString(Downloads.COLUMN_USER_AGENT, values, filteredValues);  </span><br><span class="line">    copyString(Downloads.COLUMN_REFERER, values, filteredValues);  </span><br><span class="line">    <span class="keyword">if</span> (getContext().checkCallingPermission(  </span><br><span class="line">            Downloads.PERMISSION_ACCESS_ADVANCED) == PackageManager.PERMISSION_GRANTED) &#123;  </span><br><span class="line">        copyInteger(Downloads.COLUMN_OTHER_UID, values, filteredValues);  </span><br><span class="line">    &#125;  </span><br><span class="line">    filteredValues.put(Constants.UID, Binder.getCallingUid());  </span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingUid() == <span class="number">0</span>) &#123;  </span><br><span class="line">        copyInteger(Constants.UID, values, filteredValues);  </span><br><span class="line">    &#125;  </span><br><span class="line">    copyStringWithDefault(Downloads.COLUMN_TITLE, values, filteredValues,  </span><br><span class="line">            <span class="string">""</span>);  </span><br><span class="line">    copyStringWithDefault(Downloads.COLUMN_DESCRIPTION, values,  </span><br><span class="line">            filteredValues, <span class="string">""</span>);  </span><br><span class="line">    filteredValues.put(Downloads.COLUMN_TOTAL_BYTES, -<span class="number">1</span>);  </span><br><span class="line">    filteredValues.put(Downloads.COLUMN_CURRENT_BYTES, <span class="number">0</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Context context = getContext();  </span><br><span class="line">    context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> rowID = db.insert(DB_TABLE, <span class="keyword">null</span>, filteredValues);  </span><br><span class="line">    <span class="keyword">if</span> (rowID == -<span class="number">1</span>) &#123;  </span><br><span class="line">        Log.d(Constants.TAG, <span class="string">"couldn't insert into downloads database"</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    insertRequestHeaders(db, rowID, values);  </span><br><span class="line">    context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));  </span><br><span class="line">    notifyContentChanged(uri, match);  </span><br><span class="line">    <span class="keyword">return</span> ContentUris.withAppendedId(Downloads.CONTENT_URI, rowID);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到上面的代码很长，但是我们只需要关注一些核心的代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> rowID = db.insert(DB_TABLE, <span class="keyword">null</span>, filteredValues);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;这行代码的作用主要是把下载的任务信息保存到数据库中，包括下载的URL、下载的控制状态、下载状态、总的文件大小、已下载的文件大小等默认的数据更新到数据库中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.startService(<span class="keyword">new</span> Intent(context, DownloadService.class));</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;这行代码的作用就是启动DownloadService服务。</p>
<p>&ensp;&ensp;当我们启动DownloadService之后，DownloadService服务的onCreate()数就会被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="keyword">super</span>.onCreate();  </span><br><span class="line"><span class="keyword">if</span> (Constants.LOGVV) &#123;  </span><br><span class="line">    Log.v(Constants.TAG, <span class="string">"Service onCreate"</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mSystemFacade == <span class="keyword">null</span>) &#123;  </span><br><span class="line">    mSystemFacade = <span class="keyword">new</span> RealSystemFacade(<span class="keyword">this</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">mObserver = <span class="keyword">new</span> DownloadManagerContentObserver();  </span><br><span class="line">getContentResolver().registerContentObserver(  </span><br><span class="line">   Downloads.ALL_DOWNLOADS_CONTENT_URI, <span class="keyword">true</span>, mObserver);  </span><br><span class="line"></span><br><span class="line">mNotifier = <span class="keyword">new</span> DownloadNotification(<span class="keyword">this</span>, mSystemFacade);  </span><br><span class="line">mSystemFacade.cancelAllNotifications();  </span><br><span class="line"></span><br><span class="line">updateFromProvider();  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到，在onCreate()数中，会注册一个数据库变化监听器DownloadManagerContentObserver，就是说Downloads.ALL_DOWNLOADS_CONTENT_URI这个数据库的数据发生变化的时候，该监听器的监听函数onChange()会被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> selfChange)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (Constants.LOGVV) &#123;  </span><br><span class="line">   Log.v(Constants.TAG,  </span><br><span class="line">      <span class="string">"Service ContentObserver received notification"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    updateFromProvider();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到onChange()函数会调用updateFromProvider()这个函数，从上面可以看到，onCreate()函数也会调到这个函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateFromProvider</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;  </span><br><span class="line">    mPendingUpdate = <span class="keyword">true</span>;  </span><br><span class="line">    <span class="keyword">if</span> (mUpdateThread == <span class="keyword">null</span>) &#123;  </span><br><span class="line">   mUpdateThread = <span class="keyword">new</span> UpdateThread();  </span><br><span class="line">   mSystemFacade.startThread(mUpdateThread);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以看到，updateFormProvider()函数其实就是会启动UpdateThread()这个线程。</p>
<p>&ensp;&ensp; 下面就进入到UpdateThread这个线程中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  </span><br><span class="line"></span><br><span class="line">    trimDatabase();  </span><br><span class="line">    removeSpuriousFiles();  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> keepService = <span class="keyword">false</span>;  </span><br><span class="line">    <span class="comment">// for each update from the database, remember which download is  </span></span><br><span class="line">    <span class="comment">// supposed to get restarted soonest in the future  </span></span><br><span class="line">    <span class="keyword">long</span> wakeUp = Long.MAX_VALUE;  </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;  </span><br><span class="line">   <span class="keyword">synchronized</span> (DownloadService.<span class="keyword">this</span>) &#123;  </span><br><span class="line">       <span class="keyword">if</span> (mUpdateThread != <span class="keyword">this</span>) &#123;  </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(  </span><br><span class="line">         <span class="string">"multiple UpdateThreads in DownloadService"</span>);  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">if</span> (!mPendingUpdate) &#123;  </span><br><span class="line">      mUpdateThread = <span class="keyword">null</span>;  </span><br><span class="line">      <span class="keyword">if</span> (!keepService) &#123;  </span><br><span class="line">          stopSelf();  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">if</span> (wakeUp != Long.MAX_VALUE) &#123;  </span><br><span class="line">          scheduleAlarm(wakeUp);  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">return</span>;  </span><br><span class="line">       &#125;  </span><br><span class="line">       mPendingUpdate = <span class="keyword">false</span>;  </span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">long</span> now = mSystemFacade.currentTimeMillis();  </span><br><span class="line">   keepService = <span class="keyword">false</span>;  </span><br><span class="line">   wakeUp = Long.MAX_VALUE;  </span><br><span class="line">   Set&lt;Long&gt; idsNoLongerInDatabase = <span class="keyword">new</span> HashSet&lt;Long&gt;(  </span><br><span class="line">      mDownloads.keySet());  </span><br><span class="line"></span><br><span class="line">   Cursor cursor = getContentResolver().query(  </span><br><span class="line">      Downloads.ALL_DOWNLOADS_CONTENT_URI, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,  </span><br><span class="line">      <span class="keyword">null</span>);  </span><br><span class="line">   <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;  </span><br><span class="line">       <span class="keyword">continue</span>;  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">try</span> &#123;  </span><br><span class="line">       DownloadInfo.Reader reader = <span class="keyword">new</span> DownloadInfo.Reader(  </span><br><span class="line">          getContentResolver(), cursor);  </span><br><span class="line">       <span class="keyword">int</span> idColumn = cursor.getColumnIndexOrThrow(Downloads._ID);  </span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (cursor.moveToFirst(); !cursor.isAfterLast(); cursor  </span><br><span class="line">          .moveToNext()) &#123;  </span><br><span class="line">      <span class="keyword">long</span> id = cursor.getLong(idColumn);  </span><br><span class="line">      idsNoLongerInDatabase.remove(id);  </span><br><span class="line">      DownloadInfo info = mDownloads.get(id);  </span><br><span class="line">      <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;  </span><br><span class="line">          updateDownload(reader, info, now);  </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          info = insertDownload(reader, now);  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">if</span> (info.hasCompletionNotification()) &#123;  </span><br><span class="line">          keepService = <span class="keyword">true</span>;  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">long</span> next = info.nextAction(now);  </span><br><span class="line">      <span class="keyword">if</span> (next == <span class="number">0</span>) &#123;  </span><br><span class="line">          keepService = <span class="keyword">true</span>;  </span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next &gt; <span class="number">0</span> &amp;&amp; next &lt; wakeUp) &#123;  </span><br><span class="line">          wakeUp = next;  </span><br><span class="line">      &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">       cursor.close();  </span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (Long id : idsNoLongerInDatabase) &#123;  </span><br><span class="line">       deleteDownload(id);  </span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="comment">// is there a need to start the DownloadService? yes, if there  </span></span><br><span class="line">   <span class="comment">// are rows to be deleted.  </span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (DownloadInfo info : mDownloads.values()) &#123;  </span><br><span class="line">       <span class="keyword">if</span> (info.mDeleted) &#123;  </span><br><span class="line">      keepService = <span class="keyword">true</span>;  </span><br><span class="line">      <span class="keyword">break</span>;  </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line">   mNotifier.updateNotification(mDownloads.values());  </span><br><span class="line"></span><br><span class="line">   <span class="comment">// look for all rows with deleted flag set and delete the rows  </span></span><br><span class="line">   <span class="comment">// from the database  </span></span><br><span class="line">   <span class="comment">// permanently  </span></span><br><span class="line">   <span class="keyword">for</span> (DownloadInfo info : mDownloads.values()) &#123;  </span><br><span class="line">       <span class="keyword">if</span> (info.mDeleted) &#123;  </span><br><span class="line">      Helpers.deleteFile(getContentResolver(), info.mId,  </span><br><span class="line">         info.mFileName, info.mMimeType);  </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到UpdateThread这个线程也是很长，我们大概分析一下它的作用。</p>
<p>&ensp;&ensp; 可以看到这里有一个for(;;)的死循环，它的作用是保证数据库中的下载任务都会被加载出来，然后启动所有的下载任务，同时会更新下载任务，包括更新下载任务的状态，删除一些下载任务。</p>
<p>&ensp;&ensp; 它会从数据库中取出所有的下载任务，然后根据id从mDownloads集合中找到对应的下载任务，如果没找到就会新建一个下载任务DownloadInfo。然后就会调用updateDown()和insertDown()，启动下载任务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDownload</span><span class="params">(DownloadInfo.Reader reader, DownloadInfo info,  </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> now)</span> </span>&#123;  </span><br><span class="line"><span class="keyword">int</span> oldVisibility = info.mVisibility;  </span><br><span class="line"><span class="keyword">int</span> oldStatus = info.mStatus;  </span><br><span class="line"></span><br><span class="line">reader.updateFromDatabase(info);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> lostVisibility = oldVisibility == Downloads.VISIBILITY_VISIBLE_NOTIFY_COMPLETED  </span><br><span class="line">   &amp;&amp; info.mVisibility != Downloads.VISIBILITY_VISIBLE_NOTIFY_COMPLETED  </span><br><span class="line">   &amp;&amp; Downloads.isStatusCompleted(info.mStatus);  </span><br><span class="line"><span class="keyword">boolean</span> justCompleted = !Downloads.isStatusCompleted(oldStatus)  </span><br><span class="line">   &amp;&amp; Downloads.isStatusCompleted(info.mStatus);  </span><br><span class="line"><span class="keyword">if</span> (lostVisibility || justCompleted) &#123;  </span><br><span class="line">    mSystemFacade.cancelNotification(info.mId);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">info.startIfReady(now);  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到该函数调用startIfReady()进行下载任务的启动。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startIfReady</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (!isReadyToStart(now)) &#123;  </span><br><span class="line">        <span class="keyword">return</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Constants.LOGV) &#123;  </span><br><span class="line">        Log.v(Constants.TAG, <span class="string">"Service spawning thread to handle download "</span> + mId);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (mHasActiveThread) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Multiple threads on same download"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (mStatus != Downloads.STATUS_RUNNING) &#123;  </span><br><span class="line">        mStatus = Downloads.STATUS_RUNNING;  </span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();  </span><br><span class="line">        values.put(Downloads.COLUMN_STATUS, mStatus);  </span><br><span class="line">        mContext.getContentResolver().update(getAllDownloadsUri(), values, <span class="keyword">null</span>, <span class="keyword">null</span>);  </span><br><span class="line">        <span class="keyword">return</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    DownloadThread downloader = <span class="keyword">new</span> DownloadThread(mContext, mSystemFacade, <span class="keyword">this</span>);  </span><br><span class="line">    mHasActiveThread = <span class="keyword">true</span>;  </span><br><span class="line">    mSystemFacade.startThread(downloader);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该函数是一个挺重要的函数，它会根据不同的情况判断下载任务是否需要启动。判断函数是isReadyToStart。这个函数十分关键，在我们要实现暂停下载，继续下载这个功能，都是在这里起作用的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReadyToStart</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (mHasActiveThread) &#123;  </span><br><span class="line">        <span class="comment">// already running  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (mControl == Downloads.CONTROL_PAUSED) &#123;  </span><br><span class="line">        <span class="comment">// the download is paused, so it's not going to start  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">switch</span> (mStatus) &#123;  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// status hasn't been initialized yet, this is a new download  </span></span><br><span class="line">        <span class="keyword">case</span> Downloads.STATUS_PENDING: <span class="comment">// download is explicit marked as ready to start  </span></span><br><span class="line">        <span class="keyword">case</span> Downloads.STATUS_RUNNING: <span class="comment">// download interrupted (process killed etc) while  </span></span><br><span class="line">                                            <span class="comment">// running, without a chance to update the database  </span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> Downloads.STATUS_WAITING_FOR_NETWORK:  </span><br><span class="line">        <span class="keyword">case</span> Downloads.STATUS_QUEUED_FOR_WIFI:  </span><br><span class="line">            <span class="keyword">return</span> checkCanUseNetwork() == NETWORK_OK;  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> Downloads.STATUS_WAITING_TO_RETRY:  </span><br><span class="line">            <span class="comment">// download was waiting for a delayed restart  </span></span><br><span class="line">            <span class="keyword">return</span> restartTime(now) &lt;= now;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到，当下载任务正在进行，或者下载任务状态为暂停状态，或者网络状态是否正常，这时会返回false，就是没有准备好，就不会启动下载任务。当返回true的时候，就会把当前下载任务的状态刷新为Downloads.STATUS_RUNNING,同时会启动DownloadThread下载线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  </span><br><span class="line"></span><br><span class="line">    State state = <span class="keyword">new</span> State(mInfo);  </span><br><span class="line">    PowerManager.WakeLock wakeLock = <span class="keyword">null</span>;  </span><br><span class="line">    <span class="keyword">int</span> finalStatus = Downloads.STATUS_UNKNOWN_ERROR;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        PowerManager pm = (PowerManager) mContext  </span><br><span class="line">                .getSystemService(Context.POWER_SERVICE);  </span><br><span class="line">        wakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,  </span><br><span class="line">                Constants.TAG);  </span><br><span class="line">        wakeLock.acquire();  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Constants.LOGV) &#123;  </span><br><span class="line">            Log.v(Constants.TAG, <span class="string">"initiating download for "</span> + mInfo.mUri);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> finished = <span class="keyword">false</span>;  </span><br><span class="line">        <span class="keyword">while</span> (!finished) &#123;  </span><br><span class="line">            Log.i(Constants.TAG, <span class="string">"Initiating request for download "</span>  </span><br><span class="line">                    + mInfo.mId);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Request.Builder requestBuilder = <span class="keyword">new</span> Request.Builder();  </span><br><span class="line">            InnerState innerState = <span class="keyword">new</span> InnerState();  </span><br><span class="line">            setupDestinationFile(state, innerState);  </span><br><span class="line">            addRequestHeaders(innerState, requestBuilder);  </span><br><span class="line">            requestBuilder.url(state.mRequestUri);  </span><br><span class="line"></span><br><span class="line">            Request request = requestBuilder.build();  </span><br><span class="line">            Call call = mOkHttpClient.newCall(request);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                executeDownload(innerState, state, call);  </span><br><span class="line">                finished = <span class="keyword">true</span>;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (RetryDownload exc) &#123;  </span><br><span class="line">                <span class="comment">// fall through  </span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                call.cancel();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Constants.LOGV) &#123;  </span><br><span class="line">            Log.v(Constants.TAG, <span class="string">"download completed for "</span> + mInfo.mUri);  </span><br><span class="line">        &#125;  </span><br><span class="line">        finalizeDestinationFile(state);  </span><br><span class="line">        finalStatus = Downloads.STATUS_SUCCESS;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (StopRequest error) &#123;  </span><br><span class="line">        <span class="comment">// remove the cause before printing, in case it contains PII  </span></span><br><span class="line">        Log.w(Constants.TAG, <span class="string">"Aborting request for download "</span> + mInfo.mId  </span><br><span class="line">                + <span class="string">": "</span> + error.getMessage());  </span><br><span class="line">        finalStatus = error.mFinalStatus;  </span><br><span class="line">        <span class="comment">// fall through to finally block  </span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123; <span class="comment">// sometimes the socket code throws unchecked  </span></span><br><span class="line">        <span class="comment">// exceptions  </span></span><br><span class="line">        Log.w(Constants.TAG, <span class="string">"Exception for id "</span> + mInfo.mId + <span class="string">": "</span> + ex);  </span><br><span class="line">        finalStatus = Downloads.STATUS_UNKNOWN_ERROR;  </span><br><span class="line">        <span class="comment">// falls through to the code that reports an error  </span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (wakeLock != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            wakeLock.release();  </span><br><span class="line">            wakeLock = <span class="keyword">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (mOkHttpClient != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            mOkHttpClient.cancel(<span class="keyword">null</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        cleanupDestination(state, finalStatus);  </span><br><span class="line">        notifyDownloadCompleted(finalStatus, state.mCountRetry,  </span><br><span class="line">                state.mRetryAfter, state.mGotData, state.mFilename,  </span><br><span class="line">                state.mNewUri, state.mMimeType);  </span><br><span class="line">        mInfo.mHasActiveThread = <span class="keyword">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setupDestinationFile(state, innerState);</span><br></pre></td></tr></table></figure></p>
<p>这个方法是实现断点续传的关键点。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupDestinationFile</span><span class="params">(State state, InnerState innerState)</span>  </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> StopRequest </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(state.mFilename)) &#123; <span class="comment">// only true if we've already  </span></span><br><span class="line">        <span class="comment">// run a thread for this  </span></span><br><span class="line">        <span class="comment">// download  </span></span><br><span class="line">        <span class="keyword">if</span> (!Helpers.isFilenameValid(state.mFilename)) &#123;  </span><br><span class="line">            <span class="comment">// this should never happen  </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_FILE_ERROR,  </span><br><span class="line">                    <span class="string">"found invalid internal destination filename"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">// We're resuming a download that got interrupted  </span></span><br><span class="line">        File f = <span class="keyword">new</span> File(state.mFilename);  </span><br><span class="line">        <span class="keyword">if</span> (f.exists()) &#123;  </span><br><span class="line">            <span class="keyword">long</span> fileLength = f.length();  </span><br><span class="line">            <span class="keyword">if</span> (fileLength == <span class="number">0</span>) &#123;  </span><br><span class="line">                <span class="comment">// The download hadn't actually started, we can restart from  </span></span><br><span class="line">                <span class="comment">// scratch  </span></span><br><span class="line">                f.delete();  </span><br><span class="line">                state.mFilename = <span class="keyword">null</span>;  </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInfo.mETag == <span class="keyword">null</span> &amp;&amp; !mInfo.mNoIntegrity) &#123;  </span><br><span class="line">                <span class="comment">// This should've been caught upon failure  </span></span><br><span class="line">                f.delete();  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_CANNOT_RESUME,  </span><br><span class="line">                        <span class="string">"Trying to resume a download that can't be resumed"</span>);  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// All right, we'll be able to resume this download  </span></span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    state.mStream = <span class="keyword">new</span> FileOutputStream(state.mFilename,  </span><br><span class="line">                            <span class="keyword">true</span>);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (FileNotFoundException exc) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_FILE_ERROR,  </span><br><span class="line">                            <span class="string">"while opening destination for resuming: "</span>  </span><br><span class="line">                                    + exc.toString(), exc);  </span><br><span class="line">                &#125;  </span><br><span class="line">                innerState.mBytesSoFar = (<span class="keyword">int</span>) fileLength;  </span><br><span class="line">                <span class="keyword">if</span> (mInfo.mTotalBytes != -<span class="number">1</span>) &#123;  </span><br><span class="line">                    innerState.mHeaderContentLength = Long  </span><br><span class="line">                            .toString(mInfo.mTotalBytes);  </span><br><span class="line">                &#125;  </span><br><span class="line">                innerState.mHeaderETag = mInfo.mETag;  </span><br><span class="line">                innerState.mContinuingDownload = <span class="keyword">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state.mStream != <span class="keyword">null</span>  </span><br><span class="line">            &amp;&amp; mInfo.mDestination == Downloads.DESTINATION_EXTERNAL) &#123;  </span><br><span class="line">        closeDestination(state);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 方法的流程大概是：先根据文件名建立一个文件对象，判断文件对象是否存在，如果存在再判断文件的大小，当文件大小为0的时候，把文件删除。同时，会把当前的文件的输出流保存到state.mStream，把当前文件的长度、要下载文件的总长度、文件继续下载状态保存到innerState中。<br>&ensp;&ensp; 再分析addRequestHeader（）方法，该方法也是实现断点续传的关键。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addRequestHeaders</span><span class="params">(InnerState innerState, Request.Builder requestBuilder)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (Pair&lt;String, String&gt; header : mInfo.getHeaders()) &#123;  </span><br><span class="line">        requestBuilder.addHeader(header.first, header.second);  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (innerState.mContinuingDownload) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (innerState.mHeaderETag != <span class="keyword">null</span>) &#123;  </span><br><span class="line">            requestBuilder.addHeader(<span class="string">"If-Match"</span>, mInfo.mETag);  </span><br><span class="line">        &#125;  </span><br><span class="line">        requestBuilder.addHeader(<span class="string">"Range"</span>, <span class="string">"bytes="</span> + innerState.mBytesSoFar + <span class="string">"-"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 该方法会把请求头添加到请求中，最重要的是：如果是断点续传的话，会把当前的文件大小也放到请求头中，这样服务器就会知道当前的文件已经下载了多少。</p>
<p>&ensp;&ensp; 下面来分析最重要的executeDownload方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeDownload</span><span class="params">(InnerState innerState, State state, Call call)</span> <span class="keyword">throws</span> StopRequest, RetryDownload, IOException </span>&#123;  </span><br><span class="line">    <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[Constants.BUFFER_SIZE];  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// check just before sending the request to avoid using an invalid  </span></span><br><span class="line">    <span class="comment">// connection at all  </span></span><br><span class="line">    checkConnectivity(state);  </span><br><span class="line"></span><br><span class="line">    Response response = call.execute();  </span><br><span class="line">    handleExceptionalStatus(state, innerState, response);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Constants.LOGV) &#123;  </span><br><span class="line">        Log.v(Constants.TAG, <span class="string">"received response for "</span> + mInfo.mUri);  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    processResponseHeaders(state, innerState, response);  </span><br><span class="line">    InputStream entityStream = openResponseEntity(state, response);  </span><br><span class="line">    transferData(state, innerState, data, entityStream);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到这个下载工具用到okhttp这个开源库进行网络的请求。使用okhttp得到了Response对象。</p>
<ul>
<li>先分析processResponseHeaders（）这个方法，这个方法中会获取Http请求的header，同时，根据这次下载是否为断点下载，如果是则返回，如果不是，则会把要下载的文件的输入流对象保存到state.mStream变量中。</li>
<li>再分析openResponseEntity()这个方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InputStream <span class="title">openResponseEntity</span><span class="params">(State state, Response response)</span>  </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> StopRequest </span>&#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> response.body().byteStream();  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;  </span><br><span class="line">        logNetworkState();  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(getFinalStatusForHttpError(state),  </span><br><span class="line">                <span class="string">"while getting entity: "</span> + ex.toString(), ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&ensp;&ensp; 该方法是获取Response对象的输出流变量,最后是transferData（）方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">transferData</span><span class="params">(State state, InnerState innerState, <span class="keyword">byte</span>[] data,  </span></span></span><br><span class="line"><span class="function"><span class="params">                          InputStream entityStream)</span> <span class="keyword">throws</span> StopRequest </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;  </span><br><span class="line">        <span class="keyword">int</span> bytesRead = readFromResponse(state, innerState, data,  </span><br><span class="line">                entityStream);  </span><br><span class="line">        <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123; <span class="comment">// success, end of stream already reached  </span></span><br><span class="line">            handleEndOfStream(state, innerState);  </span><br><span class="line">            <span class="keyword">return</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        state.mGotData = <span class="keyword">true</span>;  </span><br><span class="line">        writeDataToDestination(state, data, bytesRead);  </span><br><span class="line">        innerState.mBytesSoFar += bytesRead;  </span><br><span class="line">        reportProgress(state, innerState);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Constants.LOGVV) &#123;  </span><br><span class="line">            Log.v(Constants.TAG, <span class="string">"downloaded "</span> + innerState.mBytesSoFar  </span><br><span class="line">                    + <span class="string">" for "</span> + mInfo.mUri);  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        checkPausedOrCanceled(state);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp; 可以看到，这是一个for(;;)死循环，用于读取下载的文件流。</p>
<ul>
<li>先调用readFromResponse()函数，从文件输出流中读取数据，保存到data字节数组中。</li>
<li>然后调用writeDataToDestination()数，把data字节数组中的数据写到本地的文件中。</li>
<li>然后调用reportProgress()数，把已下载的文件的大小更新到数据库中。用于更新进度条的显示。</li>
</ul>
<p>&ensp;&ensp; 可以看到checkPauseOrCanceled()数。这是实现暂停下载的关键函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPausedOrCanceled</span><span class="params">(State state)</span> <span class="keyword">throws</span> StopRequest </span>&#123;  </span><br><span class="line">    <span class="keyword">synchronized</span> (mInfo) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (mInfo.mControl == Downloads.CONTROL_PAUSED) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_PAUSED_BY_APP,  </span><br><span class="line">                    <span class="string">"download paused by owner"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (mInfo.mStatus == Downloads.STATUS_CANCELED) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StopRequest(Downloads.STATUS_CANCELED,  </span><br><span class="line">                <span class="string">"download canceled"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;可以分析，这里会根据下载任务的当前状态进行判断，如果当前的任务状态被更改为Downloads.CONTROL_PAUSED时，就会抛出StopRequest的异常，当前的文件下载就会被终止，这样就可以实现暂停下载了。</p>
<p> 到此为止，DownloadManager下载的整个流程就分析完了。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>&ensp;&ensp;通过上面的分析，我们几乎理解了DownloadManager的整个工作流程。在我们下载文件的时候，我们几乎都是需要暂停下载和继续下载还有断点续传的功能。DownloadProvider代码是可以让我们能够实现这个功能了。</p>
<p>&ensp;&ensp;实现断点续传的原理其实就是我们每次添加下载任务，都会把任务的信息保存到数据库中，包括下载的URL，已下载的文件大小，总的文件大小。下次我们再进行下载的时候，把已下载的大小传到服务器中，就可以从上一次已下载的文件的基础上继续下载，就可以实现断点下载了。</p>
<p>&ensp;&ensp;暂停下载和继续下载的实现，其实只需要更新下载任务的状态就可以实现了。因为从上面的下载可以知道，在下载文件的过程中，都会检验当前的下载任务的状态，若是暂停状态，就会停止下载，跳出死循环。当我们再次改变状态为继续下载时，下载任务会被再次启动。</p>
<p>来源：<br><a href="http://blog.csdn.net/carrey1989/article/details/8060155" target="_blank" rel="noopener">http://blog.csdn.net/carrey1989/article/details/8060155</a><br><a href="http://blog.csdn.net/garment1991/article/details/54178557" target="_blank" rel="noopener">http://blog.csdn.net/garment1991/article/details/54178557</a><br><a href="http://www.trinea.cn/android/android-downloadmanager-pro/" target="_blank" rel="noopener">http://www.trinea.cn/android/android-downloadmanager-pro/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Download-Manager/" rel="tag"># Download Manager</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/03/rxjava2基础/" rel="next" title="rxjava2基础">
                <i class="fa fa-chevron-left"></i> rxjava2基础
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/21/Bitmap压缩/" rel="prev" title="Bitmap压缩">
                Bitmap压缩 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">CallteFoot</p>
              <p class="site-description motion-element" itemprop="description">The blog from a Android coder</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载文件"><span class="nav-number">1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定制Download-Manager-Notifications的样式"><span class="nav-number">2.</span> <span class="nav-text">定制Download Manager Notifications的样式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定下载保存地址"><span class="nav-number">3.</span> <span class="nav-text">指定下载保存地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取消或删除下载"><span class="nav-number">4.</span> <span class="nav-text">取消或删除下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询Download-Manager"><span class="nav-number">5.</span> <span class="nav-text">查询Download Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DownloadManager原理"><span class="nav-number">6.</span> <span class="nav-text">DownloadManager原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拓展"><span class="nav-number">7.</span> <span class="nav-text">拓展</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CallteFoot</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
