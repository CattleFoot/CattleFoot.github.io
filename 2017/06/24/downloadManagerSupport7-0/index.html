<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>downloadManagerSupport7.0 | CallteFoot&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="DownloadManager downloadmanager概述DownloadManager是Android SDK中封装的下载文件类，可以很方便开发者使用下载文件。其具体看官方APIhttps://developer.android.com/reference/android/app/DownloadManager.html  使用DownloadManager下载 123456789101">
<meta name="keywords" content="Android,Download Manager,Support,7">
<meta property="og:type" content="article">
<meta property="og:title" content="downloadManagerSupport7.0">
<meta property="og:url" content="https://cattlefoot.github.io/2017/06/24/downloadManagerSupport7-0/index.html">
<meta property="og:site_name" content="CallteFoot&#39;s blog">
<meta property="og:description" content="DownloadManager downloadmanager概述DownloadManager是Android SDK中封装的下载文件类，可以很方便开发者使用下载文件。其具体看官方APIhttps://developer.android.com/reference/android/app/DownloadManager.html  使用DownloadManager下载 123456789101">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2017-06-24T13:43:03.335Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="downloadManagerSupport7.0">
<meta name="twitter:description" content="DownloadManager downloadmanager概述DownloadManager是Android SDK中封装的下载文件类，可以很方便开发者使用下载文件。其具体看官方APIhttps://developer.android.com/reference/android/app/DownloadManager.html  使用DownloadManager下载 123456789101">
  
    <link rel="alternate" href="/atom.xml" title="CallteFoot&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">CallteFoot&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cattlefoot.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-downloadManagerSupport7-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/24/downloadManagerSupport7-0/" class="article-date">
  <time datetime="2017-06-24T13:41:50.000Z" itemprop="datePublished">2017-06-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      downloadManagerSupport7.0
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="DownloadManager"><a href="#DownloadManager" class="headerlink" title="DownloadManager"></a>DownloadManager</h3><ol>
<li><p>downloadmanager概述<br>DownloadManager是Android SDK中封装的下载文件类，可以很方便开发者使用下载文件。其具体看官方API<a href="https://developer.android.com/reference/android/app/DownloadManager.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/app/DownloadManager.html</a></p>
</li>
<li><p>使用DownloadManager下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">public class DownloadUtils &#123;</span><br><span class="line"></span><br><span class="line"> private DownloadManager mDownloadManager;</span><br><span class="line"> private Context mContext;</span><br><span class="line"> private long downloadId;</span><br><span class="line"> private String apkName;</span><br><span class="line"></span><br><span class="line"> public DownloadUtils(Context context) &#123;</span><br><span class="line">     mContext = context;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> public void download(String url, String name) &#123;</span><br><span class="line">     final String packageName = <span class="string">"com.android.providers.downloads"</span>;</span><br><span class="line">     int state = mContext.getPackageManager().getApplicationEnabledSetting(packageName);</span><br><span class="line">     //检测下载管理器是否被禁用</span><br><span class="line">     <span class="keyword">if</span> (state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED</span><br><span class="line">         || state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED_USER</span><br><span class="line">         || state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED_UNTIL_USED) &#123;</span><br><span class="line">         AlertDialog.Builder builder = new AlertDialog.Builder(mContext).setTitle(<span class="string">"温馨提示"</span>).setMessage</span><br><span class="line">             (<span class="string">"系统下载管理器被禁止，需手动打开"</span>).setPositiveButton(<span class="string">"确定"</span>, new DialogInterface.<span class="function"><span class="title">OnClickListener</span></span>() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void onClick(DialogInterface dialog, int <span class="built_in">which</span>) &#123;</span><br><span class="line">                 dialog.dismiss();</span><br><span class="line">                 try &#123;</span><br><span class="line">                     Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">                     intent.setData(Uri.parse(<span class="string">"package:"</span> + packageName));</span><br><span class="line">                     mContext.startActivity(intent);</span><br><span class="line">                 &#125; catch (ActivityNotFoundException e) &#123;</span><br><span class="line">                     Intent intent = new Intent(Settings.ACTION_MANAGE_APPLICATIONS_SETTINGS);</span><br><span class="line">                     mContext.startActivity(intent);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;).setNegativeButton(<span class="string">"取消"</span>, new DialogInterface.<span class="function"><span class="title">OnClickListener</span></span>() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void onClick(DialogInterface dialog, int <span class="built_in">which</span>) &#123;</span><br><span class="line">                 dialog.dismiss();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         builder.create().show();</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         //正常下载流程</span><br><span class="line">         apkName = name;</span><br><span class="line">         DownloadManager.Request request = new DownloadManager.Request(Uri.parse(url));</span><br><span class="line">         request.setAllowedOverRoaming(<span class="literal">false</span>);</span><br><span class="line">         //通知栏显示  request.setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED);</span><br><span class="line">         request.setTitle(AppUtils.getAppName(mContext));</span><br><span class="line">         request.setDescription(<span class="string">"正在下载中..."</span>);</span><br><span class="line">         request.setVisibleInDownloadsUi(<span class="literal">true</span>);</span><br><span class="line">         //设置下载存放的文件夹和文件名字  request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, apkName);</span><br><span class="line"></span><br><span class="line">         //获取DownloadManager</span><br><span class="line">         mDownloadManager = (DownloadManager) mContext.getSystemService(Context.DOWNLOAD_SERVICE);</span><br><span class="line">         downloadId = mDownloadManager.enqueue(request);</span><br><span class="line">         mContext.registerReceiver(mReceiver, new IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE));</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> private BroadcastReceiver mReceiver = new <span class="function"><span class="title">BroadcastReceiver</span></span>() &#123;</span><br><span class="line">     @Override</span><br><span class="line">     public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">         checkStatus();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">  * 检查下载状态</span><br><span class="line">  */</span><br><span class="line"> private void <span class="function"><span class="title">checkStatus</span></span>() &#123;</span><br><span class="line">     DownloadManager.Query query = new DownloadManager.Query();</span><br><span class="line">     query.setFilterById(downloadId);</span><br><span class="line">     Cursor cursor = mDownloadManager.query(query);</span><br><span class="line">     <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">         int status = cursor.getInt(cursor.getColumnIndex(DownloadManager.COLUMN_STATUS));</span><br><span class="line">         switch (status) &#123;</span><br><span class="line">             //下载暂停</span><br><span class="line">             <span class="keyword">case</span> DownloadManager.STATUS_PAUSED:</span><br><span class="line">                 <span class="built_in">break</span>;</span><br><span class="line">             //下载延迟</span><br><span class="line">             <span class="keyword">case</span> DownloadManager.STATUS_PENDING:</span><br><span class="line">                 <span class="built_in">break</span>;</span><br><span class="line">             //正在下载</span><br><span class="line">             <span class="keyword">case</span> DownloadManager.STATUS_RUNNING:</span><br><span class="line">                 <span class="built_in">break</span>;</span><br><span class="line">             //下载完成</span><br><span class="line">             <span class="keyword">case</span> DownloadManager.STATUS_SUCCESSFUL:</span><br><span class="line">                 installAPK();</span><br><span class="line">                 <span class="built_in">break</span>;</span><br><span class="line">             //下载失败</span><br><span class="line">             <span class="keyword">case</span> DownloadManager.STATUS_FAILED:</span><br><span class="line">                 Toast.makeText(mContext, <span class="string">"下载失败"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                 <span class="built_in">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     cursor.close();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /**</span><br><span class="line">  * 7.0兼容</span><br><span class="line">  */</span><br><span class="line"> private void <span class="function"><span class="title">installAPK</span></span>() &#123;</span><br><span class="line">     File apkFile =</span><br><span class="line">         new File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), apkName);</span><br><span class="line">     Intent intent = new Intent(Intent.ACTION_VIEW);</span><br><span class="line">     // 由于没有在Activity环境下启动Activity,设置下面的标签</span><br><span class="line">     intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">     <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">         Uri apkUri = FileProvider.getUriForFile(mContext, mContext.getPackageName() + <span class="string">".provider"</span>, apkFile);</span><br><span class="line">         intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">         intent.setDataAndType(apkUri, <span class="string">"application/vnd.android.package-archive"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         intent.setDataAndType(Uri.fromFile(apkFile), <span class="string">"application/vnd.android.package-archive"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     mContext.startActivity(intent);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="android-7-0-DownloadManager不在按照文件名分享私人存储的文件"><a href="#android-7-0-DownloadManager不在按照文件名分享私人存储的文件" class="headerlink" title="android 7.0 DownloadManager不在按照文件名分享私人存储的文件"></a>android 7.0 DownloadManager不在按照文件名分享私人存储的文件</h4><ol>
<li><p>按照开发者官网上的描述，DownloadManager不在支持使用COLUMN_LOCAL_FILENAME访问路径，其会触发SecurityException。官方建议有DownloadManager公开的文件，首选<br>的访问方式是使用ContentResolver.openFileDescriptor()。</p>
</li>
<li><p>如果使用downloadManager做下载功能的且没有做7.0适配的话，在7.0读取数据库内容时会遇到如下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: COLUMN_LOCAL_FILENAME is deprecated; use ContentResolver.openFileDescriptor() instead</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在Android 7.0中通过DownloadManager根据downId获取的uri安装apk是会得到如下错误：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Caused by: android.os.FileUriExposedException: </span><br><span class="line">file:///storage/emulated/0/Download/myApp.apk exposed beyond app through Intent.getData()</span><br></pre></td></tr></table></figure></p>
<p>同时在7.0上通过DownloadManager根据downId获取的uri变为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://downloads/all_downloads/430</span><br></pre></td></tr></table></figure></p>
<p>这些都是由于Android7.0执行了“StrictMode API 政策禁”的原因，可以用FileProvider来解决这一问题。</p>
<ol>
<li>原来的代码如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DownloadManager manager = (DownloadManager) mContext</span><br><span class="line">    .getSystemService(Context.DOWNLOAD_SERVICE);</span><br><span class="line">Cursor downloadCursor = dm.query(myDownloadQuery);</span><br><span class="line"><span class="keyword">if</span> (myDownload != null &amp;&amp; downloadCursor.moveToFirst()) &#123;</span><br><span class="line">    int fileNameIdx = downloadCursor</span><br><span class="line">        .getColumnIndex(DownloadManager.COLUMN_LOCAL_FILENAME); </span><br><span class="line">    String filePath = downloadCursor.getString(fileNameIdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="7-0获取文件路径"><a href="#7-0获取文件路径" class="headerlink" title="7.0获取文件路径"></a>7.0获取文件路径</h4><ol>
<li>DownloadManager.COLUMN_LOCAL_URI：DownloadManager的数据库表中应该是存放了对应的URI,目测应该是file: 协议开头。那看来可以通过查询这个URI，随后将URI转换成文件path路径。</li>
<li>代码如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DownloadManager manager = (DownloadManager) mContext</span><br><span class="line">    .getSystemService(Context.DOWNLOAD_SERVICE);</span><br><span class="line">Cursor downloadCursor= dm.query(myDownloadQuery);</span><br><span class="line"><span class="keyword">if</span> (downloadCursor!= null &amp;&amp; downloadCursor.moveToFirst()) &#123;</span><br><span class="line">    String filePath = null;</span><br><span class="line">    String downloadFileLocalUri = downloadCursor</span><br><span class="line">        .getString(downloadCursor.getColumnIndex(DownloadManager.COLUMN_LOCAL_URI));</span><br><span class="line">    <span class="keyword">if</span> (downloadFileLocalUri != null) &#123;</span><br><span class="line">        filePath = new File(Uri.parse(downloadFileLocalUri).getPath())</span><br><span class="line">            .getAbsolutePath();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="FileProvider"><a href="#FileProvider" class="headerlink" title="FileProvider"></a>FileProvider</h3><h4 id="Why-FileProvider？"><a href="#Why-FileProvider？" class="headerlink" title="Why FileProvider？"></a>Why FileProvider？</h4><ol>
<li>老生常谈的内容，为什么Android推荐使用FileProvider呢？其实FileProvider也不是一个新概念了，Google很早就提出这个概念了。这是因为Android上的权限管理过于松散，但是随着系统版本的不断提升，权限的不断收紧，对于进程之间的数据共享就产生了问题。于是FileProvider就出现了。</li>
<li>它通过在AndroidManifest中定义Provider，为指定的文件提供一个ContentURI，通过这个URI临时赋予第三方应用授权处理指定的某些文件。简而言之，也可以说成是使用ContentURI代替了FileURI。</li>
</ol>
<h4 id="fileprovider-使用场景"><a href="#fileprovider-使用场景" class="headerlink" title="fileprovider 使用场景"></a>fileprovider 使用场景</h4><ol>
<li>正如上面我们说到的DownloadManager的变更中，我们通过DownloadManager下载了一个APK。此时我们需要发送一个Intent，带着我们下载下来的APK的URI，通知系统的APK安装管理服务，安装这个应用。</li>
<li>此时，这个Intent就要带着这个URI离开我们的App，去到另一个应用。此时，我们就需要对这个URI进行处理。如果发送的Intent带的是一个FileURI，就会导致：<br>FileUriExposedException。</li>
</ol>
<h4 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h4><p><1>  AndroidManifest.xml:在manifest中加入如下代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">        android:exported=<span class="string">"false"</span></span><br><span class="line">        android:grantUriPermissions=<span class="string">"true"</span></span><br><span class="line">        android:authorities=<span class="string">"com.×××.fileprovider"</span></span><br><span class="line">        android:name=<span class="string">"android.support.v4.content.FileProvider"</span>&gt;</span><br><span class="line">    &lt;meta-data</span><br><span class="line">            android:name=<span class="string">"android.support.FILE_PROVIDER_PATHS"</span></span><br><span class="line">            android:resource=<span class="string">"@xml/file_paths"</span></span><br><span class="line">            /&gt;</span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure></1></p>
<ul>
<li>exported要设置为false，否则会报安全异常。</li>
<li>grantUriPermissions设置为true，表示的是设置URI临时访问权限。</li>
<li>authorities可以随便写，不过一般最好是包名.fileprovider。当然也可以是其他。</li>
</ul>
<p><2> file_paths.xml:</2></p>
<ul>
<li><p>在manifest中有下面这一句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:resource=&quot;@xml/file_paths&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们需要在res/xml目录下新建一个file_paths.xml的文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">    &lt;paths&gt;</span><br><span class="line">        &lt;root-path</span><br><span class="line">             name=&quot;/&quot;</span><br><span class="line">             path=&quot;/&quot; /&gt;</span><br><span class="line">    &lt;/paths&gt;</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>作用是指定临时授权的路径，其选项有：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">选项</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">root-paty</td>
<td style="text-align:center">根目录（/）</td>
</tr>
<tr>
<td style="text-align:center">external-path</td>
<td style="text-align:center">Context.getExternalStorageDirectory()</td>
</tr>
<tr>
<td style="text-align:center">file-path</td>
<td style="text-align:center">Context.getFilesDir()</td>
</tr>
<tr>
<td style="text-align:center">cache-path</td>
<td style="text-align:center">Context.getCacheDir()</td>
</tr>
</tbody>
</table>
<p>其中root-path指的是Android系统根目录，众所周知Android是基于Linux内核，所以Android的根目录就是“/”</p>
<p><3> 使用FileProvider:</3></p>
<ul>
<li><p>当我们拿到一个Apk文件时，需要启动安装界面进行安装。则可以使用以下方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= 24) &#123;</span><br><span class="line">    File apkFile=new File(apkFile Path);</span><br><span class="line">    Intent intent = new Intent(Intent.ACTION_VIEW);</span><br><span class="line">    Uri contentUri = FileProvider.getUriForFile(mContext,</span><br><span class="line">             <span class="string">"com.×××.fileprovider"</span>, apkFile);</span><br><span class="line">    intent.setDataAndType(contentUri,</span><br><span class="line">             <span class="string">"application/vnd.android.package-archive"</span>);</span><br><span class="line">    intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    mContext.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用FileProvider.getUriForFile()将一个FileURI转换成ContentURI</p>
</li>
<li>并且不要忘记添加Intent.FLAG_GRANT_READ_URI_PERMISSION临时的读或者写权限。这样就完成一个FileProvider共享的使用了。</li>
</ul>
<p><strong>后记</strong></p>
<ol>
<li>已兼容7.0私有文件权限问题</li>
<li>对于部分机型默认或者一些原因，下载管理器是被禁用掉的，必须手动开启或者写代码去跳转到设置界面开启，代码中已兼容。</li>
</ol>
<p>来源：<br><a href="http://www.ryanhuen.tech/2017/02/28/Android-N-Diff/" target="_blank" rel="noopener">http://www.ryanhuen.tech/2017/02/28/Android-N-Diff/</a><br><a href="http://www.jianshu.com/p/3eb4106133f4" target="_blank" rel="noopener">http://www.jianshu.com/p/3eb4106133f4</a><br><a href="http://blog.csdn.net/yulianlin/article/details/52775160" target="_blank" rel="noopener">http://blog.csdn.net/yulianlin/article/details/52775160</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cattlefoot.github.io/2017/06/24/downloadManagerSupport7-0/" data-id="cji2u6fpz00055ys61vhk6ec9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/7/">7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Download-Manager/">Download Manager</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Support/">Support</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/28/nestedscollin原理/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nestedscollin原理
        
      </div>
    </a>
  
  
    <a href="/2017/06/24/git命令和使用/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">git命令和使用</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/7/">7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Annotation/">Annotation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bitmap/">Bitmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BitmapFactory/">BitmapFactory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Download-Manager/">Download Manager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DynamicLoadApk/">DynamicLoadApk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Instant-Run/">Instant Run</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC-MVP-MVVM/">MVC MVP MVVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MulitiDex/">MulitiDex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NestedScrolling/">NestedScrolling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Options/">Options</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Small/">Small</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Support/">Support</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tool/">Tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle-plugin/">gradle plugin</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/7/" style="font-size: 10px;">7</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Annotation/" style="font-size: 15px;">Annotation</a> <a href="/tags/Bitmap/" style="font-size: 10px;">Bitmap</a> <a href="/tags/BitmapFactory/" style="font-size: 10px;">BitmapFactory</a> <a href="/tags/Download-Manager/" style="font-size: 15px;">Download Manager</a> <a href="/tags/DynamicLoadApk/" style="font-size: 10px;">DynamicLoadApk</a> <a href="/tags/Instant-Run/" style="font-size: 10px;">Instant Run</a> <a href="/tags/MVC-MVP-MVVM/" style="font-size: 10px;">MVC MVP MVVM</a> <a href="/tags/MulitiDex/" style="font-size: 10px;">MulitiDex</a> <a href="/tags/NestedScrolling/" style="font-size: 10px;">NestedScrolling</a> <a href="/tags/Options/" style="font-size: 10px;">Options</a> <a href="/tags/Small/" style="font-size: 10px;">Small</a> <a href="/tags/Support/" style="font-size: 10px;">Support</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/gradle-plugin/" style="font-size: 10px;">gradle plugin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/06/DDComponent原理剖析/">DDComponentForAndroid原理剖析</a>
          </li>
        
          <li>
            <a href="/2018/05/29/Android自定义注解处理器/">Android自定义注解处理器</a>
          </li>
        
          <li>
            <a href="/2018/04/15/mvc-mvp和mvvm理解/">mvc_mvp和mvvm理解</a>
          </li>
        
          <li>
            <a href="/2017/06/28/插件化种种和思考/">插件化种种和思考</a>
          </li>
        
          <li>
            <a href="/2017/06/28/nestedscollin原理/">nestedscollin原理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 CallteFoot<br>
      Powered by <a href="https://cattlefoot.github.io" target="_blank">CallteFoot</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>